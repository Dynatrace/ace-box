- ansible.builtin.include_tasks: source-configuration.yml

- name: Set AWX URL
  set_fact:
    awx_url: "{{ awx_ingress_data }}"

- name: Check awx availability with curl
  command: "curl -I -L {{ awx_url }}"
  register: curl_response
  failed_when: curl_response.rc != 0

- name: Check if awx is accessible
  debug:
    msg: "awx is accessible. Response: {{ curl_response.stdout }}"
  when: curl_response.rc == 0

- name: Fail if awx is not accessible
  fail:
    msg: "awx is not accessible. Response: {{ curl_response.stdout }}"
  when: curl_response.rc != 0

- name: Check SSL certificate validity
  shell: |
    echo | openssl s_client -connect {{ awx_url | regex_replace('^https?://', '') }}:443 -servername {{ awx_url | regex_replace('^https?://', '') }} 2>/dev/null | openssl x509 -noout -dates -subject -issuer -ext subjectAltName
  when: awx_url is search("https")
  register: ssl_check
  failed_when: ssl_check.rc != 0

- name: Debug SSL certificate validity
  debug:
    msg: "{{ ssl_check.stdout }}"
  when: awx_url is search("https")

- name: Extract certificate domains
  set_fact:
    cert_domains: "{{ ssl_check.stdout | regex_findall('DNS:([^,]+)') }}"
  when: awx_url is search("https")

- name: Check if certificate matches the domain name
  set_fact:
    domain_match: "{{ cert_domains | select('match', '^' + (awx_url | regex_replace('^https?://', '') | regex_replace('^.*?\\.', '*\\.')).replace('*', '.*') + '$') | list | length > 0 }}"
  debug:
    msg: "Certificate domains: {{ cert_domains }}"
  when: awx_url is search("https")


# - name: Debug expected domain
#   debug:
#     msg: "Expected domain: {{ awx_url | regex_replace('^https?://', '') }}"

- name: Fail if SSL certificate does not match the domain name
  fail:
    msg: "SSL certificate does not match the domain name. Certificate domains: {{ cert_domains }}"
  when: awx_url is search("https") and not domain_match