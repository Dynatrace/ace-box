- name: Clone the specific Kubernetes manifests folder from Easytrade repository
  ansible.builtin.git:
    repo: 'https://github.com/Dynatrace/easytrade.git'
    dest: '/tmp/easytrade-kubernetes-manifests'
    version: 'HEAD' # Use the latest commit on the default branch
    depth: 1
  register: git_clone

- name: Initialize sparse checkout
  ansible.builtin.shell: |
    cd /tmp/easytrade-kubernetes-manifests
    git sparse-checkout init --cone
  when: git_clone.changed

- name: Set the specific folder for sparse checkout
  ansible.builtin.shell: |
    cd /tmp/easytrade-kubernetes-manifests
    git sparse-checkout set kubernetes-manifests
  when: git_clone.changed

- name: Checkout the sparse checkout
  ansible.builtin.shell: |
    cd /tmp/easytrade-kubernetes-manifests
    git checkout
  when: git_clone.changed

- name: Ensure the easytrade namespace exists
  kubernetes.core.k8s:
    kind: Namespace
    api_version: v1
    name: "{{ easytrade_namespace }}"
    state: present

- name: Apply all Kubernetes manifests in the directory
  ansible.builtin.command:
    cmd: kubectl apply -f /tmp/easytrade-kubernetes-manifests/kubernetes-manifests/ -n "{{ easytrade_namespace }}"
    chdir: /tmp/easytrade-kubernetes-manifests/kubernetes-manifests/
  args:
    executable: /bin/bash

# - name: Update the service type to ClusterIP
#   kubernetes.core.k8s:
#     kind: Service
#     namespace: "{{ easytrade_namespace }}"
#     name: angular-nginx-service
#     merge_type:
#       - strategic-merge
#       - merge
#     definition:
#       spec:
#         type: ClusterIP

# - name: Render the ingress template to a file
#   ansible.builtin.template:
#     src: "{{ role_path }}/templates/easytrade-ingress.yaml.j2"
#     dest: "/tmp/easytrade-kubernetes-manifests/kubernetes-manifests/easytrade-ingress.yaml"

# - name: Apply the rendered ingress manifest
#   kubernetes.core.k8s:
#     state: present
#     namespace: "{{ easytrade_namespace }}"
#     src: "/tmp/easytrade-kubernetes-manifests/kubernetes-manifests/easytrade-ingress.yaml"

- include_tasks:
    file: add-dashboard-links.yaml