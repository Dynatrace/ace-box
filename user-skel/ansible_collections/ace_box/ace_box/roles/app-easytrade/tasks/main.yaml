- name: Set deployment strategy as a fact
  set_fact:
    manifest_strategy: "{{ manifest_strategy | default('static') }}"

- name: Determine deployment strategy
  block:
    - name: Remove the existing directory if deployment strategy is fetch_latest
      ansible.builtin.file:
        path: "{{ role_path }}/files/easytrade"
        state: absent

    - name: Clone the Easytrade repository with the full contents of the latest commit on the default branch
      ansible.builtin.git:
        repo: 'https://github.com/Dynatrace/easytrade.git'
        dest: "{{ role_path }}/files"
        version: 'HEAD'  # Use the latest commit on the default branch
        depth: 1
      register: git_clone

    - name: Template Easytrade Kustomization
      template:
        src: "{{ role_path }}/templates/kustomization-base.yml.j2"
        dest: "{{ role_path }}/files/easytrade/kubernetes-manifests/kustomization.yml"
        owner: "{{ ace_box_user }}"
        group: "{{ ace_box_user }}"
        mode: '0644'
  when: manifest_strategy == 'fetch_latest'

- name: Template Easytrade Kustomization
  template:
    src: "{{ role_path }}/templates/kustomization.yml.j2"
    dest: "{{ role_path }}/files/kustomize/base/kustomization.yml"
    owner: "{{ ace_box_user }}"
    group: "{{ ace_box_user }}"
    mode: '0644'

- name: Template Easytrade Ingress Patch
  template:
    src: "{{ role_path }}/templates/easytrade-ingress.yml.j2"
    dest: "{{ role_path }}/files/kustomize/base/ingress/easytrade-ingress.yml"
    owner: "{{ ace_box_user }}"
    group: "{{ ace_box_user }}"
    mode: '0644'

- name: Template Easytrade Labels Patch
  template:
    src: "{{ role_path }}/templates/easytrade-labels-patch.yml.j2"
    dest: "{{ role_path }}/files/kustomize/base/easytrade-labels-patch.yml"
    owner: "{{ ace_box_user }}"
    group: "{{ ace_box_user }}"
    mode: '0644'

- name: Deploy Kubernetes manifests
  include_tasks: deploy_kubernetes_manifests.yml
  when: easytrade_deploy 

- name: Add dashboard links
  include_tasks: add-dashboard-links.yml