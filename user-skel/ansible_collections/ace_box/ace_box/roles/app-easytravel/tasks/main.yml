- name: Clone the specific Kubernetes manifests folder from Easytravel repository
  ansible.builtin.git:
    repo: 'https://github.com/Dynatrace/easyTravel-Docker.git'
    dest: '/tmp/easytravel-kubernetes-manifests'
    version: 'HEAD' # Use the latest commit on the default branch
    depth: 1
  register: git_clone

- name: Initialize sparse checkout
  ansible.builtin.shell: |
    cd /tmp/easytravel-kubernetes-manifests
    git sparse-checkout init --cone
  when: git_clone.changed

- name: Set the specific folder for sparse checkout
  ansible.builtin.shell: |
    cd /tmp/easytravel-kubernetes-manifests
    git sparse-checkout set kubernetes-manifests
  when: git_clone.changed

- name: Checkout the sparse checkout
  ansible.builtin.shell: |
    cd /tmp/easytravel-kubernetes-manifests
    git checkout
  when: git_clone.changed

 
- name: Deploy Kubernetes manifests in the easytravel namespace
  kubernetes.core.k8s:
    state: present
    namespace: {{ easytravel_namespace }}
    src: "/tmp/easytravel-kubernetes-manifests/kubernetes-manifests/{{ item }}"
  loop: "{{ lookup('ansible.builtin.fileglob', '/tmp/easytravel-kubernetes-manifests/kubernetes-manifests/*.yaml', wantlist=True) }}"

- name: Update the service type to ClusterIP
  kubernetes.core.k8s:
    kind: Service
    namespace: {{ easytravel_namespace }}
    name: angular-nginx-service
    merge_type:
      - strategic-merge
      - merge
    definition:
      spec:
        type: ClusterIP

- name: Apply the ingress manifest
  kubernetes.core.k8s:
    state: present
    namespace: {{ easytravel_namespace }}
    src: "{{ role_path }}/files/easytravel-ingress.yaml"