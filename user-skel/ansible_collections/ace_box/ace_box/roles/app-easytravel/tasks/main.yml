- name: Clone the specific Kubernetes manifests folder from Easytravel repository
  ansible.builtin.git:
    repo: 'https://github.com/Dynatrace/easyTravel-Docker.git'
    dest: '/tmp/easytravel-kubernetes-manifests'
    version: 'HEAD' # Use the latest commit on the default branch
    depth: 1
  register: git_clone

- name: Initialize sparse checkout
  ansible.builtin.shell: |
    cd /tmp/easytravel-kubernetes-manifests
    git sparse-checkout init --cone
  when: git_clone.changed

- name: Set the specific folder for sparse checkout
  ansible.builtin.shell: |
    cd /tmp/easytravel-kubernetes-manifests
    git sparse-checkout set kubernetes-manifests
  when: git_clone.changed

- name: Checkout the sparse checkout
  ansible.builtin.shell: |
    cd /tmp/easytravel-kubernetes-manifests
    git checkout
  when: git_clone.changed

- name: Ensure the easytravel namespace exists
  kubernetes.core.k8s:
    kind: Namespace
    api_version: v1
    name: "{{ easytravel_namespace }}"
    state: present

- name: Apply all Kubernetes manifests in the directory
  ansible.builtin.command:
    cmd: kubectl apply -f /tmp/easytravel-kubernetes-manifests/kubernetes-manifests/ -n "{{ easytravel_namespace }}"
    chdir: /tmp/easytravel-kubernetes-manifests/kubernetes-manifests/
  args:
    executable: /bin/bash

- name: Update the service type to ClusterIP
  kubernetes.core.k8s:
    kind: Service
    namespace: "{{ easytravel_namespace }}"
    name: angular-nginx-service
    merge_type:
      - strategic-merge
      - merge
    definition:
      spec:
        type: ClusterIP

- name: Render the ingress template to a file
  ansible.builtin.template:
    src: "{{ role_path }}/templates/easytravel-ingress.yaml.j2"
    dest: "/tmp/easytravel-kubernetes-manifests/kubernetes-manifests/easytravel-ingress.yaml"

- name: Apply the rendered ingress manifest
  kubernetes.core.k8s:
    state: present
    namespace: "{{ easytravel_namespace }}"
    src: "/tmp/easytravel-kubernetes-manifests/kubernetes-manifests/easytravel-ingress.yaml"