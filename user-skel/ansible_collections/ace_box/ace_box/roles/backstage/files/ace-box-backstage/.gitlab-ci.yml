---
variables:
  # CANARY_WEIGHT:
  #   value: '100'
  #   description: 'Percentage of traffic that will be routed to canary version of application.'
  # CANARY_STEPS:
  #   value: '3'
  #   description: 'Number of steps canary weight will be incrementally shifted until CANARY_WEIGHT is reached.'
  # CANARY_STEPS_DELAY:
  #   value: '120'
  #   description: 'Delay between canary weight shifts in seconds.'
  # # Omitting an explicit value and description key hides input in web UI
  # IS_INITIAL_DEPLOYMENT: 'false'
  # RELEASE_PRODUCT: 'simplenodeservice'
  # RELEASE_STAGE: 'canary-gitlab'
  # DT_OWNER_IDENTIFIER: '$RELEASE_PRODUCT-$RELEASE_STAGE'
  IMAGE_NAME: '$DOCKER_REGISTRY_URL/backstage'
  IMAGE_TAG: 'latest'

stages:
  - build

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "api"

Build Image:
  image: docker:20.10.16
  stage: build
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: '/certs'
    DOCKER_TLS_VERIFY: 0
    DOCKER_CERT_PATH: '$DOCKER_TLS_CERTDIR/client'
    DOCKER_DAEMON_OPTIONS: '--insecure-registry=$DOCKER_REGISTRY_URL'
  services:
    - name: docker:20.10.16-dind
      entrypoint: ['sh', '-c', 'dockerd-entrypoint.sh $DOCKER_DAEMON_OPTIONS']
  before_script:
    - until docker info; do sleep 1; done
  script:
    - docker info
    - docker image build . -f packages/backend/Dockerfile --tag "$IMAGE_NAME:$IMAGE_TAG"
    - docker push "$IMAGE_NAME:$IMAGE_TAG"
