- name: Source registry url
  kubernetes.core.k8s_info:
    kind: Service
    name: "docker-registry-service"
    namespace: "default"
  register: container_registry_svc_data

- set_fact:
    registry_url: "{{ container_registry_svc_data.resources[0].spec.clusterIP }}:{{ container_registry_svc_data.resources[0].spec.ports[0].port }}"

- name: Creating file /etc/rancher/k3s/registries.yaml
  become: true
  become_user: root
  copy:
    dest: "/etc/rancher/k3s/registries.yaml"
    content: |
      mirrors:
        "{{ registry_url }}":
          endpoint:
            - "http://{{ registry_url }}"