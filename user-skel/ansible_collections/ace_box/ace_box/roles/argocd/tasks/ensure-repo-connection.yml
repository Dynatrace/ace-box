---
- set_fact:
    repo_url_parts: "{{ repo_url | split('/') }}"

- set_fact:
    repo_name: "{{ repo_url_parts[-1] | replace('.git', '') }}"
    repo_org: "{{ repo_url_parts[-2] }}"

- name: Connect repo
  kubernetes.core.k8s:
    name: "{{ repo_org }}-{{ repo_name }}"
    api_version: v1
    kind: Secret
    state: present
    namespace: "{{ argocd_namespace }}"
    resource_definition:
      metadata:
        labels:
          argocd.argoproj.io/secret-type: repository
      type: Opaque
      data:
        type: "{{ 'git' | b64encode }}"
        url: "{{ repo_url | b64encode }}"
        username: "{{ repo_username | b64encode }}"
        password: "{{ repo_password | b64encode }}"
