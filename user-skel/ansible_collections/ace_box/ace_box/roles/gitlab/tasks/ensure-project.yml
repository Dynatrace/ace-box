---
- include_tasks: source-endpoints.yml
  when: gitlab_internal_endpoint is not defined

- include_tasks: source-secret.yml
  when: gitlab_oauth_token is not defined

- block:
  - name: Lookup project "{{ gitlab_prj }}"
    uri:
      url: "{{ gitlab_internal_endpoint }}/api/v4/projects?search={{ gitlab_prj | urlencode }}"
      validate_certs: false
      method: GET
      status_code: [200, 201]
      headers:
        Content-Type: "application/json"
        Authorization: "Bearer {{ gitlab_oauth_token }}"
    register: gitlab_get_projects_result
  - set_fact:
      gitlab_project_id: "{{ gitlab_get_projects_result.json | selectattr('name', 'equalto', gitlab_prj) | map(attribute='id') | first() }}"
  rescue:
  - name: Gitlab - Create project"
    uri:
      url: "{{ gitlab_internal_endpoint }}/api/v4/projects"
      validate_certs: false
      method: POST
      status_code: [200, 201]
      headers:
        Content-Type: "application/json"
        Authorization: "Bearer {{ gitlab_oauth_token }}"
      body:
        name: "{{ gitlab_prj }}"
        namespace_id: "{{ gitlab_prj_namespace_id }}"
        visibility: "public"
      body_format: json
    register: gitlab_post_projects_result
  - set_fact:
      gitlab_project_id: "{{ gitlab_post_projects_result.json.id }}"
      new_gitlab_project_created: "{{ gitlab_post_projects_result.status is defined and gitlab_post_projects_result.status == 201 }}"
