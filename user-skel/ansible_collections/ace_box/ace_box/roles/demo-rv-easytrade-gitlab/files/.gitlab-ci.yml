variables:

  BUILD_ID:
    value: "1"
    description: |
      Build ID. Please set to 1, 2, 3, 4, 5 to select the corresponding major version.
      This ID controls feature flags and configurations specific to each version.
      
      - 1: Basic features without a problem pattern enabled
      - 2: Enables slowdown for the Easytrade OfferService
      - 3: DB not responding will be simulated, this will cause errors when trying to create any new transactions
      - 4: Order Controller Service Error: division by 0 error will be simulated. Creadit Card tab resulting in an ugly error page
      - 5: Factory Crisis: The factory wont produce new cards, which will cause the 3rd party service not to process credit card orders

  # Dynamically set the RELEASE_VERSION and RELEASE_BUILD_VERSION based on BUILD_ID
  RELEASE_VERSION: "$BUILD_ID.0.0"
  RELEASE_BUILD_VERSION: "$BUILD_ID.0.0-$CI_COMMIT_SHORT_SHA"

  STAGE_NAME_STAGING: "staging"
  STAGE_NAME_PRODUCTION: "production"
  STAGE_NAME: "$STAGE_NAME_STAGING" # default

  USE_CASE: "automation-cert"
  RELEASE_PRODUCT: "easytrade"
  RELEASE_STAGE: "$STAGE_NAME"

  MONACO_IMAGE_VERSION: "2.14.3"
  #dta and srg
  DTA_IMAGE_VERSION: "1.0.2"
  TEST_TIMEFRAME: 300 # in seconds

stages:
  - Update Manifests Staging
  - Deploy Staging
  - Test
  - Validate Release
  - Update Manifests Production
  - Deploy Production
  - Cleanup

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "api"
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"


.skip_update_rule_staging: &skip_update_rule_staging
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /skip update staging/ && $CI_PIPELINE_SOURCE != "web"'
      when: on_success

.skip_update_rule_production: &skip_update_rule_production
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /skip update production/ && $CI_PIPELINE_SOURCE != "web"'
      when: on_success

.update_manifests:
  image: bitnami/git
  script:
    - git config --global user.email "acebox@example.com"
    - git config --global user.name "acebox"
    - git checkout main || git checkout -b main

    - |    
      # Update specific flags based on BUILD_ID and reset others to false
      case "$BUILD_ID" in
        "1")
          sed -i "s/ergo_aggregator_slowdown: .*/ergo_aggregator_slowdown: false/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/db_not_responding: .*/db_not_responding: false/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/credit_card_meltdown: .*/credit_card_meltdown: false/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/factory_crisis: .*/factory_crisis: false/" $FEATURE_FLAGS_FILE_PATH
          ;;
        "2")
          sed -i "s/ergo_aggregator_slowdown: .*/ergo_aggregator_slowdown: true/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/db_not_responding: .*/db_not_responding: false/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/credit_card_meltdown: .*/credit_card_meltdown: false/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/factory_crisis: .*/factory_crisis: false/" $FEATURE_FLAGS_FILE_PATH
          ;;
        "3")
          sed -i "s/ergo_aggregator_slowdown: .*/ergo_aggregator_slowdown: false/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/db_not_responding: .*/db_not_responding: true/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/credit_card_meltdown: .*/credit_card_meltdown: false/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/factory_crisis: .*/factory_crisis: false/" $FEATURE_FLAGS_FILE_PATH
          ;;
        "4")
          sed -i "s/ergo_aggregator_slowdown: .*/ergo_aggregator_slowdown: false/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/db_not_responding: .*/db_not_responding: false/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/credit_card_meltdown: .*/credit_card_meltdown: true/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/factory_crisis: .*/factory_crisis: false/" $FEATURE_FLAGS_FILE_PATH
          ;;
        "5")
          sed -i "s/ergo_aggregator_slowdown: .*/ergo_aggregator_slowdown: false/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/db_not_responding: .*/db_not_responding: false/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/credit_card_meltdown: .*/credit_card_meltdown: false/" $FEATURE_FLAGS_FILE_PATH
          sed -i "s/factory_crisis: .*/factory_crisis: true/" $FEATURE_FLAGS_FILE_PATH
          ;;
        *)
          echo "Unknown or unsupported BUILD_ID, feature flags remain at default."
          ;;
      esac
      
    - |
      sed -i '/name: DT_RELEASE_BUILD_VERSION/{n;s|value: .*|value: "'"$RELEASE_BUILD_VERSION"'"|}; /path: \/spec\/template\/metadata\/labels\/app.kubernetes.io~1version/{n;s|value: .*|value: "'"$RELEASE_VERSION"'"|}' ./kustomize/overlays/$STAGE_NAME/kubernetes-labels-patch.yml
    - git add ./kustomize/overlays/$STAGE_NAME/kubernetes-labels-patch.yml $FEATURE_FLAGS_FILE_PATH || true
    - git commit -m "$STAGE_NAME - Update kubernetes labels and feature flags for release $RELEASE_VERSION [skip update $STAGE_NAME]" || true
    
    - export GIT_SSL_NO_VERIFY=true
    - git push "https://${GITLAB_USERNAME}:${GITLAB_PRIVATE_TOKEN}@${CI_REPOSITORY_URL#*@}" "HEAD:main" || true
    - unset GIT_SSL_NO_VERIFY

Update Manifests - Staging:
  variables:
    STAGE_NAME: "$STAGE_NAME_STAGING"
    FEATURE_FLAGS_FILE_PATH: ./kustomize/overlays/staging/feature-flags.yml
  stage: Update Manifests Staging
  extends:
    - .update_manifests
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always
    - if: '$CI_COMMIT_MESSAGE !~ /skip update/'
      when: on_success
      
Update Manifests - Production:
  <<: *skip_update_rule_staging
  variables:
    STAGE_NAME: "$STAGE_NAME_PRODUCTION"
    FEATURE_FLAGS_FILE_PATH: ./kustomize/overlays/production/feature-flags.yml
  stage: Update Manifests Production
  extends:
    - .update_manifests

.deployment_common:
  image: dtzar/helm-kubectl #bitnami/kubectl
  variables:
    NAMESPACE: $RELEASE_PRODUCT-$RELEASE_STAGE

  script:
    - git pull origin main
    - echo "Ensure the namespace exists"
    - kubectl create ns $NAMESPACE || true

    - echo "Apply the kubernetes manifests"
    - kubectl apply -k ./kustomize/overlays/$RELEASE_STAGE -n $NAMESPACE
    - sleep 60 # to give an adaptation time for the loadgen results

.apply_feature_flags:
  image: mrnonz/alpine-git-curl
  variables:
    NAMESPACE: $RELEASE_PRODUCT-$RELEASE_STAGE
    HOST_URL_INTERNAL: http://feature-flag-service.$NAMESPACE.svc.cluster.local:8080
    FEATURE_FLAGS_FILE_PATH: ./kustomize/overlays/$STAGE_NAME/feature-flags.yml
  before_script:
    - git pull origin main
    - echo $FEATURE_FLAGS_FILE_PATH
    - cat $FEATURE_FLAGS_FILE_PATH
    - ls -la $FEATURE_FLAGS_FILE_PATH
    - |
      if [ -f "$FEATURE_FLAGS_FILE_PATH" ] && [ -r "$FEATURE_FLAGS_FILE_PATH" ]; then
        while IFS=": " read -r key value || [ -n "$key" ]; do
          export $(echo $key | tr '-' '_' | tr '[:lower:]' '[:upper:]')=$(echo $value | tr -d ' ')
          echo "$key - $value"
        done < <(cat $FEATURE_FLAGS_FILE_PATH; echo)
      else
        echo "Cannot read $FEATURE_FLAGS_FILE_PATH. Check if file exists and permissions are correct."
      fi
  script:
    - echo $HOST_URL_INTERNAL
    - echo "ergo_aggregator_slowdown=$ERGO_AGGREGATOR_SLOWDOWN"
    - | 
      JSON_PAYLOAD_ERGO=$(cat <<EOF
      {
        "enabled": $ERGO_AGGREGATOR_SLOWDOWN
      }
      EOF
      )
    - |
      curl --fail -X "PUT" \
      "${HOST_URL_INTERNAL}/v1/flags/ergo_aggregator_slowdown" \
      -H "accept: application/json" \
      -H "Content-Type: application/json" \
      -d "${JSON_PAYLOAD_ERGO}"
    - echo "Check if it is enabled"
    - |
      curl -X GET "$HOST_URL_INTERNAL/v1/flags/ergo_aggregator_slowdown" -H "accept: application/json"

    - echo "db_not_responding=$DB_NOT_RESPONDING"
    - | 
      JSON_PAYLOAD_DB=$(cat <<EOF
      {
        "enabled": $DB_NOT_RESPONDING
      }
      EOF
      )
    - |
      curl --fail -X "PUT" \
      "${HOST_URL_INTERNAL}/v1/flags/db_not_responding" \
      -H "accept: application/json" \
      -H "Content-Type: application/json" \
      -d "${JSON_PAYLOAD_DB}"
    - echo "Check if it is enabled"
    - |
      curl -X GET "$HOST_URL_INTERNAL/v1/flags/db_not_responding" -H "accept: application/json"

    - echo "credit_card_meltdown=$CREDIT_CARD_MELTDOWN"
    - | 
      JSON_PAYLOAD_CR=$(cat <<EOF
      {
        "enabled": $CREDIT_CARD_MELTDOWN
      }
      EOF
      )
    - |
      curl --fail -X "PUT" \
      "${HOST_URL_INTERNAL}/v1/flags/credit_card_meltdown" \
      -H "accept: application/json" \
      -H "Content-Type: application/json" \
      -d "${JSON_PAYLOAD_CR}"
    - echo "Check if it is enabled"
    - |
      curl -X GET "$HOST_URL_INTERNAL/v1/flags/credit_card_meltdown" -H "accept: application/json"

    - echo "factory_crisis=$FACTORY_CRISIS"
    - | 
      JSON_PAYLOAD_FC=$(cat <<EOF
      {
        "enabled": $FACTORY_CRISIS
      }
      EOF
      )
    - |
      curl --fail -X "PUT" \
      "${HOST_URL_INTERNAL}/v1/flags/factory_crisis" \
      -H "accept: application/json" \
      -H "Content-Type: application/json" \
      -d "${JSON_PAYLOAD_FC}"
    - echo "Check if it is enabled"
    - |
      curl -X GET "$HOST_URL_INTERNAL/v1/flags/factory_crisis" -H "accept: application/json"

Configure DT - Staging:
  <<: *skip_update_rule_staging
  stage: Deploy Staging
  variables: 
    EASYTRADE_MANIFEST_FILE: ./easytrade/monaco/manifest.yaml
    USECASE_MANIFEST_FILE: ./monaco/manifest.yaml
  image: dynatrace/dynatrace-configuration-as-code:$MONACO_IMAGE_VERSION
  script:
    # export environment variables
    - |
      export TENANT_URL="$DT_PLATFORM_TENANT_URL"
      export TENANT_TOKEN="$DT_API_TOKEN"
      export CLIENT_ID="$DT_OAUTH_CLIENT_ID"
      export CLIENT_SECRET="$DT_OAUTH_CLIENT_SECRET"
      echo $CI_PROJECT_ID
    # run monaco for easytrade original configs
    - monaco deploy $EASYTRADE_MANIFEST_FILE --project bizevents-processing-rules,management-zone,easytrade-validation.srg -e dev --dry-run
    - monaco deploy $EASYTRADE_MANIFEST_FILE --project bizevents-processing-rules,management-zone,easytrade-validation.srg -e dev     
    # run monaco for use case specific configs
    - monaco deploy $USECASE_MANIFEST_FILE --project application,release-validation -e dev --dry-run
    - monaco deploy $USECASE_MANIFEST_FILE --project application,release-validation -e dev  

Apply Deployment Update - Staging:
  <<: *skip_update_rule_staging
  variables:
    STAGE_NAME: "$STAGE_NAME_STAGING"
  stage: Deploy Staging
  needs: ["Configure DT - Staging"]
  extends:
    - .deployment_common


Apply Feature Flags - Staging:
  <<: *skip_update_rule_staging
  stage: Deploy Staging
  needs: ["Apply Deployment Update - Staging"]
  variables:
    STAGE_NAME: "$STAGE_NAME_STAGING"
  extends:
    - .apply_feature_flags

Run Tests and Observe:
  <<: *skip_update_rule_staging
  before_script:
    - echo $(date -u +"%Y-%m-%dT%H:%M:%SZ") > srg.test.starttime
  after_script:
    - echo $(date -u +"%Y-%m-%dT%H:%M:%SZ") > srg.test.endtime
  stage: Test
  image: alpine:latest
  script:
    - echo "RELEASE_BUILD_VERSION $RELEASE_BUILD_VERSION is being tested"
    - sleep $TEST_TIMEFRAME
  dependencies:
    - "Apply Deployment Update - Staging"  
  artifacts:
    paths:
      - srg.test.starttime
      - srg.test.endtime

Evaluate with SRG:
  <<: *skip_update_rule_staging
  image: dynatraceace/dt-automation-cli:$DTA_IMAGE_VERSION
  stage: Validate Release
  variables:
    DYNATRACE_URL_GEN3: $DT_PLATFORM_TENANT_URL
    ACCOUNT_URN: $DT_OAUTH_ACCOUNT_URN
    DYNATRACE_CLIENT_ID: $DT_OAUTH_CLIENT_ID
    DYNATRACE_SECRET: $DT_OAUTH_CLIENT_SECRET
    DYNATRACE_SSO_URL: $DT_OAUTH_SSO_ENDPOINT
    SRG_EVALUATION_STOP_ON_FAILURE: "true"
  script:
    - echo "RELEASE_BUILD_VERSION $RELEASE_BUILD_VERSION is being evaluated via Site Reliability Guardian"
    - eval_start=$(cat srg.test.starttime)
    - eval_end=$(cat srg.test.endtime)
    - export LOG_LEVEL=verbose
    - dta srg evaluate --service $RELEASE_PRODUCT --stage $STAGE_NAME --release-version $RELEASE_VERSION --buildId	$RELEASE_BUILD_VERSION --start-time=$eval_start --end-time=$eval_end
  dependencies:
    - "Apply Deployment Update - Staging"
    - "Run Tests and Observe"

Apply Deployment Update - Production:
  <<: *skip_update_rule_production
  variables:
    STAGE_NAME: "$STAGE_NAME_PRODUCTION"
  stage: Deploy Production
  needs: ["Configure DT - Production"]
  extends:
    - .deployment_common

Apply Feature Flags - Production:
  <<: *skip_update_rule_production
  variables:
    STAGE_NAME: "$STAGE_NAME_PRODUCTION"
  stage: Deploy Production
  needs: ["Apply Deployment Update - Production"]
  extends:
    - .apply_feature_flags

Configure DT - Production:
  <<: *skip_update_rule_production
  stage: Deploy Production
  variables: 
    MANIFEST_FILE: ./easytrade/monaco/manifest.yaml
  image: dynatrace/dynatrace-configuration-as-code:$MONACO_IMAGE_VERSION
  script:
    # export environment variables
    - |
      export TENANT_URL="$DT_PLATFORM_TENANT_URL"
      export TENANT_TOKEN="$DT_API_TOKEN"
      export CLIENT_ID="$DT_OAUTH_CLIENT_ID"
      export CLIENT_SECRET="$DT_OAUTH_CLIENT_SECRET"
    # run monaco
    - monaco deploy $MANIFEST_FILE --project application,bizevents-processing-rules,management-zone -e dev --dry-run
    # run monaco
    - monaco deploy $MANIFEST_FILE --project application,bizevents-processing-rules,management-zone -e dev     
