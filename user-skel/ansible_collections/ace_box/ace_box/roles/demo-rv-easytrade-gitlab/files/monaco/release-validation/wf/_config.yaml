configs:
  # gitlab connection
  - id: workflowGitlabConnection
    config:
      name: "Gitlab Connection"
      template: gitlab-connection.json
      parameters:
        token:
          type: environment
          name: GITLAB_PRIVATE_TOKEN
        url:
          type: environment
          name: GITLAB_EXTERNAL_ENDPOINT
    type:
      settings:
        schema: app:dynatrace.gitlab.connector:connection
        scope: environment

  # workflow
  - id: easytrade_workflow
    config:
      name: Easytrade SRG Evaluation
      template: wf.json
      skip: false
      parameters:
        #wf related
        wf_description: "Easytrade Validation Workflow"
        wf_isPrivate: false
        #trigger related
        tag_service:
          type: environment
          name: RELEASE_PRODUCT
        tag_stage:
          type: environment
          name: RELEASE_STAGE
        #srg related
        srg_task_description: "Evaluate Easytrade app guardian objectives"
        guardian_id:
          configType: app:dynatrace.site.reliability.guardian:guardians
          project: release-validation.srg
          property: id
          type: reference
          configId: easytrade-srg
        #gitlab related
        gitlab_task_description: "Create a Gitlab Issue when SRG fails"
        gitlab_url:
          type: environment
          name: GITLAB_EXTERNAL_ENDPOINT
        gitlab_private_token:
          type: environment
          name: GITLAB_PRIVATE_TOKEN
        dt_url:
          type: environment
          name: DT_TENANT_URL
        # Query service entities
        releaseProduct:
          type: environment
          name: RELEASE_PRODUCT
        releaseStage:
          type: environment
          name: RELEASE_STAGE
        dql_service_entities_query:
          type: compound
          format: |
            fetch dt.entity.service
            | filter matchesValue(tags,"[Environment]DT_RELEASE_PRODUCT:{{ .releaseProduct }}") 
            and matchesValue(tags,"[Environment]DT_RELEASE_STAGE:{{ .releaseStage }}")
          references:
            - releaseProduct
            - releaseStage
    type:
      automation:
        resource: workflow
