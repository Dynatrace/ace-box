configs:
  # workflow
  - id: simplenodeworkflow
    config:
      name: Simplenode SRG Evaluation
      template: wf.json
      skip: false
      parameters:
        #wf related
        wf_description: "Simplenode Workflow with Guardians by Monaco for demo purposes"
        wf_isPrivate: false
        #trigger related
        tag_service:
          type: environment
          name: SRG_EVALUATION_SERVICE
        tag_stage:
          type: environment
          name: SRG_EVALUATION_STAGE
        #srg related
        srg_task_description: "Evaluate simplenode app guardian objectives"
        guardian_id:
          configType: app:dynatrace.site.reliability.guardian:guardians
          property: id
          type: reference
          configId: simplenodeguardian
        #gitlab related
        gitlab_task_description: "Create a Gitlab Issue when SRG fails"
        gitlab_url:
          type: environment
          name: GITLAB_EXTERNAL_ENDPOINT
        gitlab_private_token:
          type: environment
          name: GITLAB_PRIVATE_TOKEN
        gitlab_username:
          type: environment
          name: GITLAB_USERNAME
        gitlab_passwd:
          type: environment
          name: GITLAB_PASSWORD
        dt_url:
          type: environment
          name: DT_TENANT_URL
        # Query service entities
        releaseProduct:
          type: environment
          name: RELEASE_PRODUCT
        releaseStage:
          type: environment
          name: RELEASE_STAGE
        dql_service_entities_query:
          type: compound
          format: |
            fetch dt.entity.service
            | filter matchesValue(tags,"[Environment]DT_RELEASE_PRODUCT:{{ .releaseProduct }}") 
            and matchesValue(tags,"[Environment]DT_RELEASE_STAGE:{{ .releaseStage }}")
          references:
            - releaseProduct
            - releaseStage
    type:
      automation:
        resource: workflow
