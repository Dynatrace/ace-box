configs:
  - id: workflowGitlabConnection
    config:
      name:
        type: compound
        format: "Gitlab {{ .releaseProduct }}"
        references:
          - releaseProduct      
      template: gitlab-connection.json
      parameters:
        token:
          type: environment
          name: GITLAB_PRIVATE_TOKEN
        url:
          type: environment
          name: GITLAB_EXTERNAL_ENDPOINT
        releaseProduct:
          type: environment
          name: RELEASE_PRODUCT
    type:
      settings:
        schema: app:dynatrace.gitlab.connector:connection
        scope: environment

  # workflow
  - id: easytrade_workflow
    config:
      name: Easytrade SRG Evaluation
      template: wf.json
      skip: false
      parameters:
        #wf related
        wf_description: "Easytrade Validation Workflow"
        wf_isPrivate: false
        #trigger related
        tag_service:
          type: environment
          name: RELEASE_PRODUCT
        tag_stage:
          type: environment
          name: RELEASE_STAGE
        #srg related
        srg_task_description: "Evaluate Easytrade app guardian objectives"
        guardian_id:
          configType: app:dynatrace.site.reliability.guardian:guardians
          project: release-validation.srg
          property: id
          type: reference
          configId: easytrade-srg
        guardianName:
          configType: app:dynatrace.site.reliability.guardian:guardians
          project: release-validation.srg
          property: name
          type: reference
          configId: easytrade-srg
        #gitlab related
        gitlab_connection:
          configType: app:dynatrace.gitlab.connector:connection
          property: id
          type: reference
          configId: workflowGitlabConnection
        gitlab_task_description: "Create a Gitlab Issue when SRG fails"
        gitlab_project_id: 
          type: environment
          name: CI_PROJECT_ID
        gitlab_issue_title:
          type: compound
          format: "Guardian validation failed for {{ .guardianName }}"
          references:
            - guardianName
        dt_url:
          type: environment
          name: DT_PLATFORM_TENANT_URL
        gitlab_issue_desc: 
          type: compound
          format: |  
            Guardian validation failed for {{ .guardianName }}
            For the SRG validation details, go to 
            {{ .dt_url }}/ui/apps/dynatrace.site.reliability.guardian/analysis/{{ `{{` }} result("evaluate_srg").guardian_id {{ `}}` }}?validationId={{ `{{` }}  result("evaluate_srg").validation_id {{ `}}` }}'
          references:
            - dt_url
            - guardianName
        # Query service entities
        releaseProduct:
          type: environment
          name: RELEASE_PRODUCT
        releaseStage:
          type: environment
          name: RELEASE_STAGE
        dql_service_entities_query:
          type: compound
          format: |
            fetch dt.entity.service
            | filter matchesValue(tags,"[Environment]DT_RELEASE_PRODUCT:{{ .releaseProduct }}") 
            and matchesValue(tags,"[Environment]DT_RELEASE_STAGE:{{ .releaseStage }}")
          references:
            - releaseProduct
            - releaseStage
    type:
      automation:
        resource: workflow
