- name: "Gitea - Check if org {{ gitea_org }} exists"
  uri:
    url: "{{ ingress_protocol }}://{{ gitea_domain }}/api/v1/orgs/{{ gitea_org }}?access_token={{ gitea_access_token }}"
    validate_certs: no
    status_code: [200, 201, 404]
  register: org_result
  tags:
    - git

- name: "Gitea - Create org {{ gitea_org }}"
  shell: "curl -k -d '{\"full_name\":\"{{ gitea_org }}\", \"visibility\":\"public\", \"username\":\"{{ gitea_org }}\"}' -H \"Content-Type: application/json\" -X POST \"{{ ingress_protocol }}://{{ gitea_domain }}/api/v1/orgs?access_token={{ gitea_access_token }}\""
  when: org_result.status != 200
  tags:
    - git

- name: "Gitea - Create repo {{ gitea_org }}/{{ gitea_repo }}"
  become_user: "{{ non_root_user }}"
  shell: "curl -k -d '{\"name\":\"{{ gitea_repo }}\", \"private\":false, \"auto-init\":true}' -H \"Content-Type: application/json\" -X POST \"{{ ingress_protocol }}://{{ gitea_domain }}/api/v1/org/{{ gitea_org }}/repos?access_token={{ gitea_access_token }}\""
  tags:
    - git

- name: "Git - Init local repo {{ gitea_org }}/{{ gitea_repo }}"
  become_user: "{{ non_root_user }}"
  shell: "cd /home/{{ non_root_user }}/repos/{{ gitea_source_folder }} && git init"
  tags:
    - git

- name: "Git - Add remote {{ ingress_protocol }}://{{ git_user}}:******@{{ gitea_domain }}/{{ gitea_org }}/{{ gitea_repo }}"
  become_user: "{{ non_root_user }}"
  shell: "cd /home/{{ non_root_user }}/repos/{{ gitea_source_folder }} && git remote add origin {{ ingress_protocol }}://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ gitea_org }}/{{ gitea_repo }}"
  tags:
    - git

- name: "Git - Commit initial version of {{ gitea_org }}/{{ gitea_repo }}"
  become_user: "{{ non_root_user }}"
  shell: "cd /home/{{ non_root_user }}/repos/{{ gitea_source_folder }} && git add -A && git commit -m 'Init repo - Enjoy!'"
  tags:
    - git

- name: "Git - Publish initial version of {{ gitea_org }}/{{ gitea_repo }}"
  become_user: "{{ non_root_user }}"
  shell: "cd /home/{{ non_root_user }}/repos/{{ gitea_source_folder }} && git push -u origin master"
  tags:
    - git

# - name: "Gitea - clone repo {{ ingress_protocol }}://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ gitea_org }}/{{ gitea_repo }}"
#   become_user: "{{ non_root_user }}"
#   shell: "cd /home/{{ non_root_user }} && git clone {{ ingress_protocol }}://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ gitea_org }}/{{ gitea_repo }}"
#   tags:
#     - git

# - name: "Gitea - Add files to {{ gitea_org }}/{{ gitea_repo }}"
#   become_user: "{{ non_root_user }}"
#   shell: "cp -rT /home/{{ non_root_user }}/repos/{{ gitea_source_folder }} /home/{{ non_root_user }}/{{ gitea_repo }}"
#   tags:
#     - git

# - name: "Gitea - Git add/commit for {{ gitea_org }}/{{ gitea_repo }}"
#   become_user: "{{ non_root_user }}"
#   shell: "cd /home/{{ non_root_user }}/{{ gitea_repo }} && git add . && git commit -m \"Initial commit, enjoy\""
#   tags:
#     - git

# - name: "Gitea - Git push for {{ gitea_org }}/{{ gitea_repo }}"
#   become_user: "{{ non_root_user }}"
#   shell: "cd /home/{{ non_root_user }}/{{ gitea_repo }} && git push {{ ingress_protocol }}://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ gitea_org }}/{{ gitea_repo }}"
#   tags:
#     - git

# - name: "Gitea - Delete {{ gitea_org }}/{{ gitea_repo }}"
#   become_user: "{{ non_root_user }}"
#   shell: "rm -rf /home/{{ non_root_user }}/{{ gitea_repo }}"
#   tags:
#     - never
#     - git_uninstall