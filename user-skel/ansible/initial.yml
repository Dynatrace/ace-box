---
- hosts: localhost
  connection: local
  become: true
  vars_files:
    - ../ace-box.conf.yml
  vars:
    acebox_mode:                      "{{ acebox['features']['mode'] | default('training') }}"
    dynatrace_tenant_url:             "{{ dynatrace['tenant'] }}" 
    dynatrace_paas_token:             "{{ dynatrace['paastoken'] }}"
    dynatrace_api_token:              "{{ dynatrace['apitoken'] }}"
    dynatrace_operator_version:       "{{ acebox['config']['dynatrace']['operator_version'] | default('v0.3.0') }}"
    jenkins_setcreds:                 "{{ acebox['config']['jenkins']['setcreds'] | default(true) }}"
    jenkins_helm_chart_version:       "{{ acebox['config']['jenkins']['helm_chart_version'] | default('3.3.18') }}"
    jenkins_version:                  "{{ acebox['config']['jenkins']['version'] | default('2.277.4') }}"
    jenkins_ace_lib_url:              "{{ acebox['config']['jenkins']['ace_lib_url'] | default('https://github.com/dynatrace-ace/dynatrace-jenkins-library.git') }}"
    jenkins_keptn_lib_url:            "{{ acebox['config']['jenkins']['ace_lib_url'] | default('https://github.com/keptn-sandbox/keptn-jenkins-library.git') }}"
    jenkins_user:                     "admin" #not used for configuring jenkins
    jenkins_password:                 "dynatrace" #not used for configuring jenkins
    keptn_version:                        "{{ acebox['config']['keptn']['version'] | default('0.10.0')}}"
    keptn_dynatrace_service_version:      "{{ acebox['config']['keptn']['dynatrace_service_version'] | default('0.17.1')}}"
    microk8s_addons:            "{{ acebox['config']['microk8s']['addons'] | default('dns storage registry ingress ') }}"
    microk8s_domain_ext:        "{{ acebox['config']['microk8s']['domain_ext'] | default('nip.io') }}"
    microk8s_release_channel:   "{{ acebox['config']['microk8s']['release_channel'] | default('1.21/stable') }}"
    git_user:                   "{{ (((acebox | default({})).config | default({}) ).git | default({}) ).user | default('dynatrace') }}"
    git_password:               "{{ (((acebox | default({})).config | default({}) ).git | default({}) ).password | default('dynatrace') }}"
    git_email:                  "{{ (((acebox | default({})).config | default({}) ).git | default({}) ).email | default('ace@ace.ace') }}"
    git_org:                    "{{ (((acebox | default({})).config | default({}) ).git | default({}) ).org | default('ace') }}"
    git_repo:                   "{{ (((acebox | default({})).config | default({}) ).git | default({}) ).repo | default('ace') }}"
    #gitea_version:               "{{ acebox.config.git.version | default('1.11.6') }}"
    gitea_version:               "{{ (((acebox | default({})).config | default({}) ).git | default({}) ).version |default('1.14.6') }}"
    #gitea_version:               "{{ acebox|json_query('config.git.version') | default('1.11.6') }}"
    activegate_download_location: "{{ acebox['config']['activegate']['download_location'] | default('/tmp/Dynatrace-ActiveGate-Linux-x86-latest.sh') }}"
    monaco_download_version: "v1.5.0"
    dashboard_user: "{{ (((acebox | default({})).config | default({}) ).dashboard | default({}) ).user | default('dynatrace') }}"
    dashboard_password: "{{ (((acebox | default({})).config | default({}) ).dashboard | default({}) ).password | default('dynatrace') }}"
    awx_operator_version: "0.12.0"
    awx_admin_username: "admin"
    # awx_admin_password: "" # A secret will be created automatically. Password can be retrieved by running $ kubectl -n awx get secret awx-admin-password -o jsonpath='{.data.password}' | base64 -d
  tasks:
  - name: Set default Variables
    set_fact:
      non_root_user: "{{ lookup('env','USER') }}"
    when: non_root_user is not defined
    tags:
      - always

  - set_fact:
      public_ip: "n/a"
    when: public_ip is not defined
    tags:
      - always

  # - set_fact:
  #     acebox_provisioner: "vagrant"
  #   when: acebox_provisioner is not defined
  #   tags:
  #     - always

  - set_fact:
      use_custom_domain: false
    when: use_custom_domain is not defined
    tags:
      - always

  - set_fact:
      custom_domain: "n/a"
    when: use_custom_domain is not defined or custom_domain is not defined
  roles:
  - role: common
    tags:
      - always
  - role: init
    tags:
      - never
      - init
      - all
  - role: microk8s
    tags:
      - never
      - microk8s
      - all
  - role: helm
    tags:
      - never
      - helm
      - all
  - role: dt-activegate
    tags:
      - never
      - dynatrace
      - all
  - role: dt-oneagent
    tags:
      - never
      - dynatrace
      - all
  - role: gitea
    tags:
      - never
      - gitea
      - all
  - role: gitlab
    tags:
      - never
      - gitlab
      - all
  - role: repositories
    tags:
      - never
      - repositories
      - all
  - role: monaco
    tags:
      - never
      - monaco
      - all
  - role: keptn
    tags:
      - never
      - keptn
      - all
  - role: jenkins
    tags:
      - never
      - jenkins
      - all
  - role: awx
    tags:
      - never
      - awx
      - all
  - role: dashboard
    tags:
      - never
      - dashboard
      - all
  - role: post-install
    tags:
      - never
      - all
