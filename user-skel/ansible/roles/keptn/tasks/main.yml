---
- name: Update ca flavor
  include_role:
    name: config-v2
    tasks_from: set-var
  vars:
  - var_key_to_set: "ca_flavor"
  - var_value_to_set: "KEPTN"
  when: ca_flavor is not defined or ca_flavor != "KEPTN"

- name: Download Keptn CLI
  get_url:
    url: "https://get.keptn.sh"
    dest: "{{ keptn_cli_download_location }}"
    mode: +x
    timeout: 300
  when: not keptn_cli_download_location is exists

- name: Install Keptn CLI
  shell: KEPTN_VERSION="{{ keptn_version }}" /bin/bash "{{ keptn_cli_download_location }}"
  args:
    creates: "/usr/local/bin/keptn"

- name: Deploy Keptn on Kubernetes cluster
  kubernetes.core.helm:
    name: keptn
    chart_ref: "https://github.com/keptn/keptn/releases/download/{{ keptn_version }}/keptn-{{ keptn_version }}.tgz"
    release_namespace: "{{ keptn_namespace }}"
    create_namespace: true
    wait: true
    wait_timeout: 15m
  register: keptn_helm_chart

- name: Template ingress file
  ansible.builtin.template:
    src: keptn-ingress.yml.j2
    dest: /tmp/keptn-ingress.yml
    owner: "{{ ace_box_user }}"
    group: "{{ ace_box_user }}"
    mode: '0644'

- name: Create ingress
  kubernetes.core.k8s:
    state: present
    src: /tmp/keptn-ingress.yml
    namespace: "{{ keptn_namespace }}"
  register: keptn_ingress

- name: Keptn - Source Keptn secrets
  include: roles/keptn/tasks/source-secret.yml
      
- name: Keptn - Authenticate CLI
  shell: "/usr/local/bin/keptn auth --api-token {{ keptn_api_token }} --endpoint {{ ingress_protocol }}://{{ keptn_ingress_domain }}/api"
  when: keptn_helm_chart.changed or keptn_ingress.changed

- name: Keptn - Install JMeter service
  include: roles/keptn/tasks/jmeter-service.yml

- name: Keptn - Install Dynatrace service
  include: roles/keptn/tasks/dynatrace-service.yml
