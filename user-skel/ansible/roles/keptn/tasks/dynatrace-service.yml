- name: Keptn - Delete Gitea dynatrace
  shell: /snap/bin/microk8s.kubectl -n {{ keptn_namespace }} delete secret dynatrace
  ignore_errors: yes

- name: Keptn - Create secret dynatrace
  shell: >
    /snap/bin/microk8s.kubectl -n {{ keptn_namespace }} create secret generic dynatrace 
    --from-literal="DT_TENANT={{ dynatrace_tenant_url | regex_replace('https://', '') }}" 
    --from-literal="DT_API_TOKEN={{ dynatrace_api_token }}" 
    --from-literal="DT_PAAS_TOKEN={{ dynatrace_api_token }}" 
    --from-literal="KEPTN_API_URL={{ ingress_protocol }}://{{ keptn_ingress_domain }}/api" 
    --from-literal="KEPTN_API_TOKEN={{ keptn_api_token }}" 
    --from-literal="KEPTN_BRIDGE_URL={{ ingress_protocol }}://{{ keptn_ingress_domain }}/bridge"

- name: Keptn - Install Dynatrace service
  become_user: "{{ non_root_user }}"
  shell: >
    helm upgrade --install dynatrace-service -n {{ keptn_namespace }} 
    https://github.com/keptn-contrib/dynatrace-service/releases/download/{{ keptn_dynatrace_service_version }}/dynatrace-service-{{ keptn_dynatrace_service_version }}.tgz
