---
- name: Create BasicAuth for NGINX Ingress
  block:
  - set_fact:
      password_encrypted: "{{ dashboard_password | password_hash('md5') }}"
  - set_fact:
      authb64encoded: "{{ [dashboard_user, password_encrypted] | join(':') | b64encode }}"
  when: ingress_class != "istio"

- name: Create BasicAuth for Istio Ingress
  block:
  - set_fact:
      authb64encoded: "{{ [dashboard_user, dashboard_password] | join(':') | b64encode }}"
  when: ingress_class == "istio"

- name: Source Gitea secrets
  include_role:
    name: gitea
    tasks_from: source-secret
  when: git_flavor is defined and git_flavor == "GITEA"

- name: Source Gitlab secrets
  include_role:
    name: gitlab
    tasks_from: source-secret
  when: git_flavor is defined and git_flavor == "GITLAB"

- name: Source Jenkins secrets
  include_role:
    name: jenkins
    tasks_from: source-secret

- block:
  - name: Source Keptn secrets
    include_role:
      name: keptn
      tasks_from: source-secret
  - name: Source Keptn host
    include_role:
      name: keptn
      tasks_from: source-endpoints
  when: cloud_automation_flavor is defined and cloud_automation_flavor == "KEPTN"

- name: Source Cloud Automation secrets
  include_role:
    name: cloudautomation
    tasks_from: source-secret
  when: cloud_automation_flavor is defined and cloud_automation_flavor == "CLOUD_AUTOMATION"

- name: Source AWX credentials
  include_role:
    name: awx
    tasks_from: source-secrets

- name: Copy Helm chart
  copy:
    src: helm-chart/
    dest: /tmp/dashboard-helm-chart/

- name: Install
  kubernetes.core.helm:
    name: ace-dashboard
    chart_ref: /tmp/dashboard-helm-chart
    release_namespace: "{{ dashboard_namespace }}"
    create_namespace: true
    wait: true
    wait_timeout: 15m
    values:
      domain: "{{ ingress_domain }}"
      authb64encoded: "{{ authb64encoded }}"
      image: "{{ dashboard_image }}"
      ingress:
        enabled: "{{ ingress_class != 'istio' }}"
        class: "{{ ingress_class }}"
      virtualservice:
        enabled: "{{ ingress_class == 'istio' }}"
      env:
        SIMPLENODEAPP_URL_STAGING: "{{ ingress_protocol }}://simplenodeservice.staging.{{ ingress_domain }}"
        SIMPLENODEAPP_URL_PRODUCTION: "{{ ingress_protocol }}://simplenodeservice.production.{{ ingress_domain }}"
        SIMPLENODEAPP_URL_CANARY: "{{ ingress_protocol }}://simplenodeservice.canary.{{ ingress_domain }}"
        JENKINS_URL: "{{ ingress_protocol }}://jenkins.{{ ingress_domain }}"
        JENKINS_USER: "{{ jenkins_username | default(None) }}"
        JENKINS_PASSWORD: "{{ jenkins_password | default(None) }}"
        GITEA_URL: "{{ ingress_protocol }}://gitea.{{ ingress_domain }}"
        GITEA_USER: "{{ gitea_username | default(None) }}"
        GITEA_PASSWORD: "{{ gitea_password | default(None) }}"
        GITEA_PAT: "{{ gitea_access_token | default(None) }}"
        GITLAB_URL: "{{ ingress_protocol }}://gitlab.{{ ingress_domain }}"
        GITLAB_USER: "{{ gitlab_username | default(None) }}"
        GITLAB_PASSWORD: "{{ gitlab_password | default(None) }}"
        GITLAB_OAUTH: "{{ gitlab_oauth_token | default(None) }}"
        AWX_URL: "{{ ingress_protocol }}://awx.{{ ingress_domain }}"
        AWX_USER: "{{ awx_admin_username | default(None) }}"
        AWX_PASSWORD: "{{ awx_admin_password | default(None) }}"
        KEPTN_API_URL: "{{ keptn_endpoint | default(None) }}"
        KEPTN_API_TOKEN: "{{ keptn_api_token | default(None) }}"
        KEPTN_BRIDGE_URL: "{{ keptn_bridge | default(None) }}"
        KEPTN_BRIDGE_USER: "{{ keptn_bridge_user | default(None) }}"
        KEPTN_BRIDGE_PASSWORD: "{{ keptn_bridge_password | default(None) }}"
        DT_TENANT_URL: "{{ dynatrace_tenant_url | default(None) }}"
        CLOUD_AUTOMATION_API_URL: "{{ cloud_automation_endpoint | default(None) }}"
        CLOUD_AUTOMATION_API_TOKEN: "{{ cloud_automation_api_token | default(None) }}"
        CLOUD_AUTOMATION_BRIDGE_URL: "{{ cloud_automation_bridge | default(None) }}"
        QUALITY_GATES_PROVIDER: "{{ cloud_automation_flavor | default(None) }}"
        K8S_PROVIDER: "MICROK8S"

- name: Print some dashboard config
  debug:
    msg:
      - "Dashboard URL: {{ ingress_protocol }}://dashboard.{{ ingress_domain }}"
      - "Dashboard username: {{ dashboard_user }}"
      - "Dashboard password: {{ dashboard_password }}"

# TBD: Source from secret
    # --set envSecrets.GITEA_USER.name=gitea-admin
    # --set envSecrets.GITEA_USER.key=git_user
    # --set envSecrets.GITEA_PASSWORD.name=gitea-admin
    # --set envSecrets.GITEA_PASSWORD.key=git_password
    # --set envSecrets.GITEA_PAT.name=gitea-admin
    # --set envSecrets.GITEA_PAT.key=access_token