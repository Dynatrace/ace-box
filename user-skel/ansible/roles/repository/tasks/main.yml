- name: Repository - Init local repo {{ repo_src }}
  become_user: "{{ non_root_user }}"
  shell: "cd {{ repo_src }} && git init"
  ignore_errors: yes

- name: Repository - Commit local changes {{ repo_src }}
  become_user: "{{ non_root_user }}"
  shell: "cd {{ repo_src }} && git add . && git commit -m \"Init repo. Have fun!\""
  ignore_errors: yes

- name: Repository - Add remote Gitea {{ gitea_org }}/{{ gitea_repo }}
  become_user: "{{ non_root_user }}"
  block:
    - name: "'add' gitea"
      shell: "cd {{ repo_src }} && git remote add gitea {{ ingress_protocol }}://{{ gitea_username }}:{{ gitea_password }}@{{ gitea_domain }}/{{ gitea_org }}/{{ gitea_repo }}"
  rescue:
    - name: "'set-url' gitea"
      shell: "cd {{ repo_src }} && git remote set-url gitea {{ ingress_protocol }}://{{ gitea_username }}:{{ gitea_password }}@{{ gitea_domain }}/{{ gitea_org }}/{{ gitea_repo }}"
  when: push_to_gitea

- name: Repository - Publish {{ gitea_org }}/{{ gitea_repo }} to Gitea
  become_user: "{{ non_root_user }}"
  shell: "cd {{ repo_src }} && git push gitea master"
  when: push_to_gitea

- name: Repository - Add remote Gitlab {{ gitlab_group }}/{{ gitlab_repo }}
  become_user: "{{ non_root_user }}"
  block:
    - name: "'add' gitlab"
      shell: "cd {{ repo_src }} && git remote add gitlab {{ ingress_protocol }}://{{ gitlab_username }}:{{ gitlab_password }}@{{ gitlab_domain }}/{{ gitlab_group }}/{{ gitlab_repo }}.git"
  rescue:
    - name: "'set-url' gitlab"
      shell: "cd {{ repo_src }} && git remote set-url gitlab {{ ingress_protocol }}://{{ gitlab_username }}:{{ gitlab_password }}@{{ gitlab_domain }}/{{ gitlab_group }}/{{ gitlab_repo }}.git"
  when: push_to_gitlab

- name: Repository - Publish {{ gitlab_group }}/{{ gitlab_repo }}.git to Gitlab
  become_user: "{{ non_root_user }}"
  shell: "cd {{ repo_src }} && git push gitlab master"
  when: push_to_gitlab
