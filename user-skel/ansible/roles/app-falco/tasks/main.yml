---
# Deploy falco from github repository
- name: Add falco chart repo
  kubernetes.core.helm_repository:
    name: falcosecurity
    repo_url: "https://falcosecurity.github.io/charts"

- name: repo update
  command:
    cmd: helm repo update

- name: Install Falco
  command:
    cmd: helm install falco falcosecurity/falco --set falcosidekick.enabled=true --namespace falco --create-namespace

- name: Falco - Template values file
  ansible.builtin.template:
    src: values.yml.j2
    dest: "{{ role_path }}/files/values.yml"
    owner: "{{ ace_box_user }}"
    group: "{{ ace_box_user }}"
    mode: '0644'


- name: Upgrade falcosidekick using helm
  command:
    cmd: helm upgrade falco falcosecurity/falco -f {{ role_path }}/files/values.yaml --namespace falco

