---
- name: Validate required extra_vars
  include_role:
    name: config-v2
    tasks_from: validate-extra-vars
  vars:
    required_extra_vars:
      - { key: 'dt_oauth_sso_endpoint' }
      - { key: 'dt_oauth_client_id', regex: 'dt0s02\..' }
      - { key: 'dt_oauth_client_secret', regex: 'dt0s02\..' }
      - { key: 'dt_oauth_account_urn', regex: 'urn:dtaccount:.' }
      - { key: 'dt_environment_url_gen3' }

- include_role:
    name: microk8s

- include_role:
    name: gitea

# TBD: Add custom monaco

- ansible.builtin.include_tasks: simplenode.yml

- include_role:
    name: load-generator
  vars:
    load_gen_endpoint: "{{ ingress_protocol }}://simplenodeservice-canary-jenkins.{{ ingress_domain }}/api/invoke?url=https://www.dynatrace.com"
    load_gen_namespace: "canary-jenkins-loadgen"

- ansible.builtin.include_tasks: jenkins.yml

- ansible.builtin.include_tasks: awx.yml

- include_role:
    name: awx
    tasks_from: source-secrets

- include_role:
    name: jenkins-config
    tasks_from: ensure-credentials
  vars:
    credentials_value: "{{ awx_admin_username }}"
    credentials_id: "AWX_ADMIN_USER"
    credentials_description: "AWX_ADMIN_USER"
    credentials_class: StringCredentialsImpl

- include_role:
    name: jenkins-config
    tasks_from: ensure-credentials
  vars:
    credentials_value: "{{ awx_admin_password }}"
    credentials_id: "AWX_ADMIN_PASSWORD"
    credentials_description: "AWX_ADMIN_PASSWORD"
    credentials_class: StringCredentialsImpl

- include_role:
    name: dashboard
  vars:
    include_dashboard_value_file: "{{ playbook_dir }}/roles/demo-ar-workflows-ansible/templates/demo-ar-workflows-ansible-dashboard.yml.j2"
