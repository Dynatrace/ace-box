include:
  - remote: "https://gitlab.com/dynatrace-ace/dynatrace-gitlab-library/-/raw/master/dynatrace_event.yaml"

variables:
  BUILD_ID:
    value: "1"
    description: "Build ID. Please set to 1, 2, 3 or 4."
  RELEASE_VERSION: "v$BUILD_ID.0.3"
  RELEASE_BUILD_VERSION: "$BUILD_ID.0.3"
  RELEASE_PRODUCT: "simplenodeservice"
  RELEASE_STAGE: "simplenode-gitlab-staging"
  MANIFEST_FILE: ./monaco/manifest.yaml
  MONACO_IMAGE_VERSION: 2.2.0
  DTA_IMAGE_VERSION: latest
  SRG_EVALUATION_SERVICE: "simplenode" 
  SRG_EVALUATION_STAGE: "staging"
  TEST_TIMEFRAME: "8m"

stages:
  - configure-dynatrace
  - deploy-staging
  - test
  - validate-release
  - deploy-production
  - cleanup

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"

.monaco_common:
  image: dynatrace/dynatrace-configuration-as-code:$MONACO_IMAGE_VERSION

configure-dt-infra:
  extends:
    - .monaco_common
  stage: configure-dynatrace
  script:
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project infrastructure --dry-run
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project infrastructure

sleep:
  extends:
    - .monaco_common
  stage: configure-dynatrace
  needs: ["configure-dt-infra"]
  script:
    # Sleep an additional 120 seconds (90 + delay for the start of the next jobs) to give Dynatrace some time
    # to tag host according to current config before sending config events
    - sleep 90

1-configure-dt-staging:
  extends:
    - .monaco_common
  stage: deploy-staging
  variables:
    RELEASE_STAGE: "simplenode-gitlab-staging"
  script:
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project app --group staging --dry-run
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project app --group staging
    # SRG and WF configrations
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project srg --group staging --dry-run
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project srg --group staging

2-send-config-event-dt-staging:
  extends:
    - .monaco_common
    - .dynatrace_event
  stage: deploy-staging
  needs: ["1-configure-dt-staging"]
  variables:
    DYNATRACE_ENV_URL: "$DT_TENANT_URL"
    DYNATRACE_API_TOKEN: "$DT_API_TOKEN"
    EVENT_TYPE: "CUSTOM_CONFIGURATION"
    ATTACH_RULES_FILE: "dynatrace/dynatrace.host-attachrules.yaml"
    DT_HOST_TAG: "simplenode-gitlab-staging-$DEMO_IDENTIFIER"
    DESCRIPTION: "Monaco deployment successful: simplenode-gitlab-staging"
    CONFIGURATION: "simplenode-gitlab-staging"
    CUSTOM_PROPERTIES: '{"Approved by": "ACE"}'

3-deployment-staging:
  image: dtzar/helm-kubectl
  stage: deploy-staging
  needs: ["1-configure-dt-staging"]
  script:
    - echo "BUILD_ID $BUILD_ID is being deployed"
    - >
      helm upgrade --install simplenode-gitlab-staging helm/simplenodeservice 
      --set image="dynatraceace/simplenodeservice:$RELEASE_BUILD_VERSION"
      --set domain="$INGRESS_DOMAIN" 
      --set version="$RELEASE_VERSION"
      --set build_version="$RELEASE_BUILD_VERSION" 
      --set environment="$RELEASE_STAGE" 
      --namespace "$RELEASE_STAGE" --create-namespace 
      --wait
    - sleep 150

4-send-deploy-event-dt-staging:
  extends: .dynatrace_event
  stage: deploy-staging
  needs: ["3-deployment-staging"]
  variables:
    DYNATRACE_ENV_URL: "$DT_TENANT_URL"
    DYNATRACE_API_TOKEN: "$DT_API_TOKEN"
    DESCRIPTION: "$RELEASE_PRODUCT $RELEASE_VERSION deployed"
    CUSTOM_PROPERTIES: '{"namespace":"$RELEASE_STAGE"}'
    EVENT_TYPE: "CUSTOM_DEPLOYMENT"
    DEPLOYMENT_NAME: "simplenode_gitlab"
    DEPLOYMENT_VERSION: "$RELEASE_VERSION"
    REMEDIATION_ACTION: "Ansible Tower"
    DT_NAMESPACE: "$RELEASE_STAGE"

run-tests:
  before_script:
    - echo $(date -u +"%Y-%m-%dT%H:%M:%SZ") > srg.test.starttime
  after_script:
    - echo $(date -u +"%Y-%m-%dT%H:%M:%SZ") > srg.test.endtime
  stage: test
  variables:
    LOCUST_LOCUSTFILE: locust/locustfile.py
    LOCUST_CONFIG: locust/locust.conf
    LOCUST_HOST: "http://simplenodeservice-$RELEASE_STAGE.$INGRESS_DOMAIN"
    LOCUST_LOAD_TEST_NAME: "Loadtest - $RELEASE_BUILD_VERSION"
  image: locustio/locust
  script:
    - echo "BUILD_ID $BUILD_ID is being tested"
    - locust --config $LOCUST_CONFIG --locustfile $LOCUST_LOCUSTFILE --host $LOCUST_HOST --run-time $TEST_TIMEFRAME
  artifacts:
    paths:
      - srg.test.starttime
      - srg.test.endtime

srg-release-validation:
  image: dynatraceace/dt-automation-cli:$DTA_IMAGE_VERSION
  stage: validate-release
  variables:
    DYNATRACE_URL_GEN3: $DT_PLATFORM_TENANT_URL
    ACCOUNT_URN: $DT_OAUTH_ACCOUNT_URN
    DYNATRACE_CLIENT_ID: $DT_OAUTH_CLIENT_ID
    DYNATRACE_SECRET: $DT_OAUTH_CLIENT_SECRET
    DYNATRACE_SSO_URL: $DT_OAUTH_SSO_ENDPOINT
    SRG_EVALUATION_STOP_ON_FAILURE: "false"
  script:
    - echo "BUILD_ID $BUILD_ID is being evaluated via Site Reliability Guardian"
    - eval_start=$(cat srg.test.starttime)
    - eval_end=$(cat srg.test.endtime)
    - export LOG_LEVEL=verbose
    - dta srg evaluate --service $SRG_EVALUATION_SERVICE --stage $SRG_EVALUATION_STAGE --start-time=$eval_start --end-time=$eval_end --stop-on-failure


1-configure-dt-production:
  extends:
    - .monaco_common
  stage: deploy-production
  variables:
    RELEASE_STAGE: "simplenode-gitlab-prod"
  script:
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project app --group production --dry-run
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project app --group production

2-send-config-event-dt-production:
  extends:
    - .monaco_common
    - .dynatrace_event
  stage: deploy-production
  needs: ["1-configure-dt-production"]
  variables:
    DYNATRACE_ENV_URL: "$DT_TENANT_URL"
    DYNATRACE_API_TOKEN: "$DT_API_TOKEN"
    EVENT_TYPE: "CUSTOM_CONFIGURATION"
    ATTACH_RULES_FILE: "dynatrace/dynatrace.host-attachrules.yaml"
    DT_HOST_TAG: "simplenode-gitlab-prod-$DEMO_IDENTIFIER"
    DESCRIPTION: "Monaco deployment successful: simplenode-gitlab-prod"
    CONFIGURATION: "simplenode-gitlab-prod"
    CUSTOM_PROPERTIES: '{"Approved by": "ACE"}'

3-deployment-production:
  image: dtzar/helm-kubectl
  stage: deploy-production
  needs: ["1-configure-dt-production"]
  variables:
    RELEASE_STAGE: "simplenode-gitlab-prod"
  script:
    - echo "BUILD_ID $BUILD_ID is being deployed to production"
    - >
      helm upgrade --install simplenode-gitlab-production helm/simplenodeservice 
      --set image="dynatraceace/simplenodeservice:$RELEASE_BUILD_VERSION"
      --set domain="$INGRESS_DOMAIN" 
      --set version="$RELEASE_VERSION"
      --set build_version="$RELEASE_BUILD_VERSION" 
      --set environment="$RELEASE_STAGE" 
      --namespace "$RELEASE_STAGE" --create-namespace 
      --wait
    - sleep 150

4-send-deploy-event-dt-production:
  extends: .dynatrace_event
  stage: deploy-production
  needs: ["3-deployment-production"]
  variables:
    RELEASE_STAGE: "simplenode-gitlab-prod"
    DYNATRACE_ENV_URL: "$DT_TENANT_URL"
    DYNATRACE_API_TOKEN: "$DT_API_TOKEN"
    DESCRIPTION: "$RELEASE_PRODUCT $RELEASE_VERSION deployed"
    CUSTOM_PROPERTIES: '{"namespace":"$RELEASE_STAGE"}'
    EVENT_TYPE: "CUSTOM_DEPLOYMENT"
    DEPLOYMENT_NAME: "simplenode_gitlab"
    DEPLOYMENT_VERSION: "$RELEASE_VERSION"
    REMEDIATION_ACTION: "Ansible Tower"
    DT_NAMESPACE: "$RELEASE_STAGE"


cleanup-monaco:
  image: dynatrace/dynatrace-configuration-as-code:$MONACO_IMAGE_VERSION
  stage: cleanup
  script:
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco delete --manifest $MANIFEST_FILE --file ./monaco/delete.yaml
  when: manual
