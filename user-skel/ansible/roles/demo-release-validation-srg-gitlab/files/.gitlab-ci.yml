include:
  - remote: "https://gitlab.com/dynatrace-ace/dynatrace-gitlab-library/-/raw/master/dynatrace_event.yaml"

variables:
  BUILD_ID:
    value: "1"
    description: "Build ID. Please set to 1, 2, 3 or 4."
  RELEASE_VERSION: "v$BUILD_ID.0.3"
  RELEASE_BUILD_VERSION: "$BUILD_ID.0.3"
  RELEASE_PRODUCT: "simplenodeservice"
  RELEASE_STAGE: "simplenode-gitlab-staging"
  MANIFEST_FILE: ./monaco/manifest.yaml

stages:
  - init
  - deploy-staging
  - test
  - evaluate
  - deploy-production


workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"

monaco_infra:
  image: dynatrace/dynatrace-configuration-as-code:2.1.0
  stage: init
  script:
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project infrastructure --dry-run
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project infrastructure
    - sleep 30
  rules:
    - if: $BUILD_ID == "1"

monaco_staging:
  image: dynatrace/dynatrace-configuration-as-code:2.1.0
  stage: init
  needs: ["monaco_infra"]
  variables:
    RELEASE_STAGE: "simplenode-gitlab-staging"
  script:
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project app.staging,app.shared --dry-run
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project app.staging,app.shared
  rules:
    - if: $BUILD_ID == "1"

monaco_prod:
  image: dynatrace/dynatrace-configuration-as-code:2.1.0
  stage: init
  needs: ["monaco_infra"]
  variables:
    RELEASE_STAGE: "simplenode-gitlab-prod"
  script:
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project app.prod,app.shared --dry-run
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project app.prod,app.shared
  rules:
    - if: $BUILD_ID == "1"

monaco_srg:
  image: dynatrace/dynatrace-configuration-as-code:2.1.0
  stage: init
  needs: ["monaco_infra"]
  variables:
    DT_OAUTH_CLIENT_ID: client.id
    DT_OAUTH_CLIENT_SECRET: client.secret
  script:
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project srg --dry-run
    - MONACO_FEAT_AUTOMATION_RESOURCES=1 monaco deploy $MANIFEST_FILE --project srg
  rules:
    - if: $BUILD_ID == "1"

monaco_config_sleep:
  image: dynatrace/dynatrace-configuration-as-code:2.1.0
  stage: init
  needs: ["monaco_prod"]
  script:
    # Sleep an additional 120 seconds to give Dynatrace some time
    # to tag host according to current config before sending config events
    - sleep 120

monaco_config_event_staging:
  extends: .dynatrace_event
  stage: init
  needs: ["monaco_config_sleep"]
  variables:
    DYNATRACE_ENV_URL: "$DT_TENANT_URL"
    DYNATRACE_API_TOKEN: "$DT_API_TOKEN"
    EVENT_TYPE: "CUSTOM_CONFIGURATION"
    ATTACH_RULES_FILE: "dynatrace/dynatrace.host-attachrules.yaml"
    DT_HOST_TAG: "simplenode-gitlab-staging"
    DESCRIPTION: "Monaco deployment successful: simplenode-gitlab-staging"
    CONFIGURATION: "simplenode-gitlab-staging"
    CUSTOM_PROPERTIES: '{"Approved by": "ACE"}'

monaco_config_event_prod:
  extends: .dynatrace_event
  stage: init
  needs: ["monaco_config_sleep"]
  variables:
    DYNATRACE_ENV_URL: "$DT_TENANT_URL"
    DYNATRACE_API_TOKEN: "$DT_API_TOKEN"
    EVENT_TYPE: "CUSTOM_CONFIGURATION"
    ATTACH_RULES_FILE: "dynatrace/dynatrace.host-attachrules.yaml"
    DT_HOST_TAG: "simplenode-gitlab-prod"
    DESCRIPTION: "Monaco deployment successful: simplenode-gitlab-prod"
    CONFIGURATION: "simplenode-gitlab-prod"
    CUSTOM_PROPERTIES: '{"Approved by": "ACE"}'

deployment-staging:
  image: dtzar/helm-kubectl
  stage: deploy-staging
  needs: ["monaco_staging"]
  script:
    - echo "Release Version $RELEASE_VERSION is being deployed"
    - >
      helm upgrade --install simplenode-gitlab-staging helm/simplenodeservice 
      --set image="dynatraceace/simplenodeservice:$RELEASE_BUILD_VERSION"
      --set domain="$INGRESS_DOMAIN" 
      --set version="$RELEASE_VERSION"
      --set build_version="$RELEASE_BUILD_VERSION" 
      --set environment="$RELEASE_STAGE" 
      --namespace "$RELEASE_STAGE" --create-namespace 
      --wait
    - sleep 150

dynatrace_deploy_event_staging:
  extends: .dynatrace_event
  stage: deploy-staging
  needs: ["deployment-staging"]
  variables:
    DYNATRACE_ENV_URL: "$DT_TENANT_URL"
    DYNATRACE_API_TOKEN: "$DT_API_TOKEN"
    DESCRIPTION: "$RELEASE_PRODUCT $RELEASE_VERSION deployed"
    CUSTOM_PROPERTIES: '{"namespace":"$RELEASE_STAGE"}'
    EVENT_TYPE: "CUSTOM_DEPLOYMENT"
    DEPLOYMENT_NAME: "simplenode_gitlab"
    DEPLOYMENT_VERSION: "$RELEASE_VERSION"
    REMEDIATION_ACTION: "Ansible Tower"
    DT_NAMESPACE: "$RELEASE_STAGE"

run-tests:
  before_script:
    - echo $(date -u +"%Y-%m-%dT%H:%M:%SZ") > srg.test.starttime
  after_script:
    - echo $(date -u +"%Y-%m-%dT%H:%M:%SZ") > srg.test.endtime
  stage: test
  needs: ["deployment-staging"]
  variables:
    LOCUST_LOCUSTFILE: locust/locustfile.py
    LOCUST_CONFIG: locust/locust.conf
    LOCUST_HOST: "http://simplenodeservice.$RELEASE_STAGE"
    LOCUST_LOAD_TEST_NAME: "Loadtest - $RELEASE_BUILD_VERSION"
  image: locustio/locust
  script:
    - locust --config $LOCUST_CONFIG --locustfile $LOCUST_LOCUSTFILE --host $LOCUST_HOST
  artifacts:
    paths:
      - srg.test.starttime
      - srg.test.endtime

trigger_srg_and_receive_result:
  image: dynatraceace/dt-automation-cli:latest
  stage: evaluate
  needs: ["run-tests"]
  variables:
    LOG_LEVEL: "verbose"
    APP_NAME: "simplenode-gitlab"
    DYNATRACE_URL_GEN3: $DT_PLATFORM_TENANT_URL
    ACCOUNT_URN: $DT_OAUTH_ACCOUNT_URN
    DYNATRACE_CLIENT_ID: $DT_OAUTH_CLIENT_ID
    DYNATRACE_SECRET: $DT_OAUTH_CLIENT_SECRET
    DYNATRACE_SSO_URL: $DT_OAUTH_SSO_ENDPOINT
    SRG_EVALUATION_STOP_ON_FAILURE: "false"
  script:
    - eval_start=$(cat srg.test.starttime)
    - eval_end=$(cat srg.test.endtime)
    - /dta srg evaluate $APP_NAME


deployment-production:
  image: dtzar/helm-kubectl
  stage: deploy-production
  variables:
    RELEASE_STAGE: "simplenode-gitlab-prod"
  needs: ["trigger_srg_and_receive_result"]
  script:
    - echo "Release Version $RELEASE_VERSION is being deployed"
    - >
      helm upgrade --install simplenode-gitlab-production helm/simplenodeservice 
      --set image="dynatraceace/simplenodeservice:$RELEASE_BUILD_VERSION"
      --set domain="$INGRESS_DOMAIN" 
      --set version="$RELEASE_VERSION"
      --set build_version="$RELEASE_BUILD_VERSION" 
      --set environment="$RELEASE_STAGE" 
      --namespace "$RELEASE_STAGE" --create-namespace 
      --wait
    - sleep 150

dynatrace_deploy_event_production:
  extends: .dynatrace_event
  stage: deploy-production
  needs: ["deployment-production"]
  variables:
    RELEASE_STAGE: "simplenode-gitlab-prod"
    DYNATRACE_ENV_URL: "$DT_TENANT_URL"
    DYNATRACE_API_TOKEN: "$DT_API_TOKEN"
    DESCRIPTION: "$RELEASE_PRODUCT $RELEASE_VERSION deployed"
    CUSTOM_PROPERTIES: '{"namespace":"$RELEASE_STAGE"}'
    EVENT_TYPE: "CUSTOM_DEPLOYMENT"
    DEPLOYMENT_NAME: "simplenode_gitlab"
    DEPLOYMENT_VERSION: "$RELEASE_VERSION"
    REMEDIATION_ACTION: "Ansible Tower"
    DT_NAMESPACE: "$RELEASE_STAGE"