---
- name: Create Dynatrace namespace
  kubernetes.core.k8s:
    name: "{{ dt_operator_namespace }}"
    api_version: v1
    kind: Namespace
    state: present

- block:
  - name: Download dynatrace-operator manifest
    ansible.builtin.get_url:
      url: "https://github.com/Dynatrace/dynatrace-operator/releases/download/{{ dt_operator_release }}/kubernetes.yaml"
      dest: /tmp/dt_operator.yaml
      mode: '0664'
  - name: Apply dynatrace-operator manifest
    kubernetes.core.k8s:
      state: present
      src: /tmp/dt_operator.yaml
    register: dt_operator
    retries: 10
    delay: 5
    until: dt_operator is not failed

- name: Create OneAgent secret
  kubernetes.core.k8s:
    name: dynakube
    api_version: v1
    kind: Secret
    state: present
    namespace: "{{ dt_operator_namespace }}"
    resource_definition:
      type: Opaque
      data:
        apiToken: "{{ dynatrace_api_token | b64encode }}"
        paasToken: "{{ dynatrace_paas_token | b64encode }}"

- block:
  - name: Template Dynakube manifest
    ansible.builtin.template:
      src: dynakube.yaml.j2
      dest: /tmp/dynakube.yaml
      owner: "{{ ace_box_user }}"
      group: "{{ ace_box_user }}"
      mode: "0644"
  - name: Apply Dynakube manifest
    kubernetes.core.k8s:
      state: present
      src: /tmp/dynakube.yaml
    register: dynakube
    retries: 10
    delay: 10
    until: dynakube is not failed
