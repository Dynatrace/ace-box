- name: Cloud Automation - Download CLI
  unarchive:
    src: "https://github.com/keptn/keptn/releases/download/{{ cloud_automation_version }}/keptn-{{ cloud_automation_version }}-linux-amd64.tar.gz"
    dest: /tmp
    remote_src: yes
    mode: +x
  when: feature_cloud_automation

- name: Cloud Automation - Rename CLI
  become: true
  shell: "cp /tmp/keptn-{{ cloud_automation_version }}-linux-amd64 /usr/local/bin/keptn"
  when: feature_cloud_automation

- name: Cloud Automation - Create Cloud Automation namespace
  shell: >
    /snap/bin/microk8s.kubectl create ns {{ cloud_automation_namespace }} 
  when: feature_cloud_automation

- name: Cloud Automation - Create Cloud Automation secrets
  include: roles/cloudautomation/tasks/create-secret.yml
  when: feature_cloud_automation

- name: Cloud Automation - Authenticate CLI
  become_user: "{{ non_root_user }}"
  shell: "/usr/local/bin/keptn auth --api-token {{ cloud_automation_api_token }} --endpoint {{ cloud_automation_tenant_url }}/api"
  when: feature_cloud_automation

- name: Cloud Automation - Delete secret dynatrace
  become_user: "{{ non_root_user }}"
  shell: "/usr/local/bin/keptn delete secret dynatrace"
  ignore_errors: yes
  when: feature_cloud_automation

- name: Cloud Automation - Create secret dynatrace
  become_user: "{{ non_root_user }}"
  shell: "/usr/local/bin/keptn create secret dynatrace --from-literal=DT_TENANT={{ dynatrace_tenant_url }} --from-literal=DT_API_TOKEN={{ dynatrace_api_token }} --scope=dynatrace-service"
  when: feature_cloud_automation