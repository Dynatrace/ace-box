- name: "Gitea - Check if org {{ gitea_org }} exists"
  uri:
    url: "{{ custom_domain_protocol }}://{{ gitea_domain }}/api/v1/orgs/{{ gitea_org }}?access_token={{ gitea_access_token }}"
    validate_certs: no
    status_code: [200, 201, 404]
  register: org_result
  tags:
    - git

- name: "Gitea - Create org {{ gitea_org }}"
  shell: "curl -k -d '{\"full_name\":\"{{ gitea_org }}\", \"visibility\":\"public\", \"username\":\"{{ gitea_org }}\"}' -H \"Content-Type: application/json\" -X POST \"{{ custom_domain_protocol }}://{{ gitea_domain }}/api/v1/orgs?access_token={{ gitea_access_token }}\""
  when: org_result.status != 200
  tags:
    - git

- name: "Gitea - Create repo {{ gitea_org }}/{{ gitea_repo }}"
  become_user: "{{ non_root_user }}"
  shell: "curl -k -d '{\"name\":\"{{ gitea_repo }}\", \"private\":false, \"auto-init\":true}' -H \"Content-Type: application/json\" -X POST \"{{ custom_domain_protocol }}://{{ gitea_domain }}/api/v1/org/{{ gitea_org }}/repos?access_token={{ gitea_access_token }}\""
  tags:
    - git

- name: "Gitea - clone repo {{ custom_domain_protocol }}://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ gitea_org }}/{{ gitea_repo }}"
  become_user: "{{ non_root_user }}"
  shell: "cd /home/{{ non_root_user }} && git clone {{ custom_domain_protocol }}://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ gitea_org }}/{{ gitea_repo }}"
  tags:
    - git

- name: "Gitea - Add files to {{ gitea_org }}/{{ gitea_repo }}"
  become_user: "{{ non_root_user }}"
  shell: "cp -rT /vagrant/repos/{{ gitea_source_folder }} /home/{{ non_root_user }}/{{ gitea_repo }}"
  tags:
    - git

- name: "Gitea - Git add/commit for {{ gitea_org }}/{{ gitea_repo }}"
  become_user: "{{ non_root_user }}"
  shell: "cd /home/{{ non_root_user }}/{{ gitea_repo }} && git add . && git commit -m \"Initial commit, enjoy\""
  tags:
    - git

- name: "Gitea - Git push for {{ gitea_org }}/{{ gitea_repo }}"
  become_user: "{{ non_root_user }}"
  shell: "cd /home/{{ non_root_user }}/{{ gitea_repo }} && git push {{ custom_domain_protocol }}://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ gitea_org }}/{{ gitea_repo }}"
  tags:
    - git

- name: "Gitea - Delete {{ gitea_org }}/{{ gitea_repo }}"
  become_user: "{{ non_root_user }}"
  shell: "rm -rf /home/{{ non_root_user }}/{{ gitea_repo }}"
  tags:
    - never
    - git_uninstall