- name: "Gitea - Check if org {{ gitea_org }} exists"
  uri:
    url: "http://{{ gitea_domain }}/api/v1/orgs/{{ gitea_org }}?access_token={{ gitea_access_token }}"
    validate_certs: no
    status_code: [200, 201, 404]
  register: org_result

- name: "Gitea - Create org {{ gitea_org }}"
  shell: "curl -k -d '{\"full_name\":\"{{ gitea_org }}\", \"visibility\":\"public\", \"username\":\"{{ gitea_org }}\"}' -H \"Content-Type: application/json\" -X POST \"http://{{ gitea_domain }}/api/v1/orgs?access_token={{ gitea_access_token }}\""
  when: org_result.status != 200

- name: "Gitea - Create repo {{ gitea_org }}/{{ gitea_repo }}"
  become_user: vagrant
  shell: "curl -k -d '{\"name\":\"{{ gitea_repo }}\", \"private\":false, \"auto-init\":true}' -H \"Content-Type: application/json\" -X POST \"http://{{ gitea_domain }}/api/v1/org/{{ gitea_org }}/repos?access_token={{ gitea_access_token }}\""

- name: "Gitea - clone repo http://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ gitea_org }}/{{ gitea_repo }}"
  become_user: vagrant
  shell: "cd /home/vagrant && git clone http://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ gitea_org }}/{{ gitea_repo }}" 

- name: "Gitea - Add files to {{ gitea_org }}/{{ gitea_repo }}"
  become_user: vagrant
  shell: "cp -R /vagrant/repos/{{ gitea_source_folder }}/* /home/vagrant/{{ gitea_repo }}"

- name: "Gitea - Git add/commit for {{ gitea_org }}/{{ gitea_repo }}"
  become_user: vagrant
  shell: "cd /home/vagrant/{{ gitea_repo }} && git add . && git commit -m \"Initial commit, enjoy\""

- name: "Gitea - Git push for {{ gitea_org }}/{{ gitea_repo }}"
  become_user: vagrant
  shell: "cd /home/vagrant/{{ gitea_repo }} && git push http://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ gitea_org }}/{{ gitea_repo }}" 