- set_fact:
    dynatrace_tenant_nohttps: "{{ dynatrace_tenant_url | regex_replace('https://', '') }}"

- set_fact:
    tenant_login: "{{ dynatrace_tenant_nohttps | regex_search(qry) }}"
  vars:
    qry: '([^.]+)'

- debug: var=tenant_login

- name: Dynatrace Activegate Kubernetes - Set placeholders
  shell: >
    sed 
    -e "s|REGISTRY_PLACEHOLDER|{{ dynatrace_tenant_nohttps }}|"  
    /vagrant/k8s/dtactivegate_kubernetes.yml > /vagrant/k8s/dtactivegate_kubernetes_gen.yml

# - name: Dynatrace Activegate Kubernetes - Login to tenant
#   become_user: vagrant
#   shell: "docker login -u {{ tenant_login }} -p {{ dynatrace_paas_token }} {{ dynatrace_tenant_url }}"

- name: "Dynatrace Activegate Kubernetes - Create secret"
  shell: "/snap/bin/microk8s.kubectl -n dynatrace create secret docker-registry dt-environment-registry --docker-server={{ dynatrace_tenant_nohttps }} --docker-username={{ tenant_login }} --docker-password={{ dynatrace_paas_token }}"

- name: "Dynatrace Activegate Kubernetes - Deploy"
  shell: "/snap/bin/microk8s.kubectl apply -f /vagrant/k8s/dtactivegate_kubernetes_gen.yml"

#https://www.dynatrace.com/support/help/technology-support/cloud-platforms/kubernetes/monitoring/monitor-kubernetes-clusters-with-dynatrace/
- name: "Dynatrace Activegate Kubernetes - Create service account and cluster role " 
  shell: "/snap/bin/microk8s.kubectl apply -f https://www.dynatrace.com/support/help/codefiles/kubernetes/kubernetes-monitoring-service-account.yaml"

- name: "Dynatrace Activegate Kubernetes - Get bearer token " 
  shell: "/snap/bin/microk8s.kubectl get secret $(kubectl get sa dynatrace-monitoring -o jsonpath='{.secrets[0].name}' -n dynatrace) -o jsonpath='{.data.token}' -n dynatrace | base64 --decode"
  register: token_raw

- set_fact:
    kube_bearer_token: "{{  token_raw.stdout }}"

- debug: var=kube_bearer_token