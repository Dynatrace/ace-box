
# - name: Gitea - Add helm repo
#   become_user: vagrant
#   shell: /snap/bin/helm repo add k8s-land https://charts.k8s.land

# - name: Gitea - Set placeholders
#   shell: sed -e "s|GITEA_INGRESS_PLACEHOLDER|gitea.{{ ingress_domain }}|"  /vagrant/k8s/gitea-values.yml > /vagrant/k8s/gitea-values-gen.yml

# - name: Gitea - Install gitea using helm
#   become_user: vagrant
#   shell: /snap/bin/helm install gitea k8s-land/gitea -f /vagrant/k8s/gitea-values-gen.yml --namespace ace
#   ignore_errors: yes

# - name: Gitea - Wait for gitea to be ready
#   shell: /snap/bin/microk8s.kubectl -n ace rollout status deployment gitea-gitea
- hosts: localhost
  vars:
    git_org: "test"
    gitea_domain: "gitea.192.168.50.10.nip.io"
    gitea_access_token: "dfa2ef4ec4f0cea0d1bb294e00d6fc50a090db85"
  tasks:
  - name: Gitea - Wait for API to be up
    uri:
      url: "https://{{ gitea_domain }}/api/v1/admin/orgs?access_token={{ gitea_access_token }}"
      status_code: 200
      validate_certs: no
    register: result
    until: result.status == 200
    retries: 5
    delay: 1

  - debug: var=result
  #https://gitea.192.168.50.10.nip.io/api/v1/admin/orgs?access_token=d88f9098d244b137fb1c24c9e6eee9cf7d09634f"
# kubectl exec -t $(kubectl -n ace get po -l app=gitea-gitea -o jsonpath='{.items[0].metadata.name}') -n ace -- bash -c 'su - git -c "/usr/local/bin/gitea --custom-path /data/gitea --config /data/gitea/conf/app.ini  admin create-user --username kristof --password dynatrace --email sdfsdf@ssfgf.com --admin"'



  # kubectl exec -it $(kubectl -n ace get po -l app=gitea-gitea -o jsonpath='{.items[0].metadata.name}') -n ace -- bash -c "su - git ; whoami ; /usr/local/bin/gitea admin create-user --username kristof --password dynatrace --email sdfsdf@ssfgf.com --admin"

