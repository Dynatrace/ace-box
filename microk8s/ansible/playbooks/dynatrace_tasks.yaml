- name: Install required packages 
  apt:
    name: "{{ packages }}"
    state: present
    update_cache: yes
  vars:
    packages:
    - xvfb
    - x11-xkb-utils 
    - xfonts-100dpi
    - xfonts-75dpi
    - xfonts-scalable
    - libasound2
    - libatk-bridge2.0-0
    - libatk1.0-0
    - libc6:amd64
    - libcairo2
    - libcups2 
    - libgdk-pixbuf2.0-0 
    - libgtk-3-0 
    - libnspr4 
    - libnss3 
    - libxss1 
    - xdg-utils

- name: Download chromium deb packages archive
  get_url:
    url: https://s3.amazonaws.com/synthetic-packages/Chromium/deb/chromium-78.0.3904.108-0ubuntu0.16.04.1.tgz
    dest: /tmp/chromium.tgz

- name: Ensure chromium directory exists
  file:
    path: /tmp/chromium
    state: directory

- name: Extract chromium packages to tmp folder
  unarchive:
    src: /tmp/chromium.tgz
    dest: /tmp/chromium
    remote_src: yes

- name: Find chromium codec packages
  find:
    paths: /tmp/chromium
    patterns: '*chromium-codecs*.deb'
  register: chromiumcodec

- name: Find chromium browser packages
  find:
    paths: /tmp/chromium
    patterns: '*chromium-browser*.deb'
  register: chromiumbrowser

- name: Install chromium .deb package
  apt:
    state: present
    deb: "{{ item }}"
  with_items:
    - "{{ chromiumcodec.files[0].path }}"
    - "{{ chromiumbrowser.files[0].path }}"

- name: Prevent chromium packages from being upgraded
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  with_items:
    - chromium-browser
    - chromium-codecs-ffmpeg-extra

- name: Download ActiveGate installer
  get_url:
    url: https://{{ dynatrace['tenant'] }}/api/v1/deployment/installer/gateway/unix/latest?arch=x86&flavor=default
    dest: /tmp/Dynatrace-ActiveGate-Linux-x86-latest.sh
    mode: +x
    headers:
      Authorization: "Api-token {{ dynatrace['paastoken'] }}"

- name: Install synthetic-enabled ActiveGate
  command:
    cmd: /tmp/Dynatrace-ActiveGate-Linux-x86-latest.sh --enable-synthetic
    creates: /opt/dynatrace/synthetic/uninstall.sh  