- name: Dashboard - Wait for registry to be ready
  shell: /snap/bin/microk8s.kubectl -n container-registry rollout status deployment registry

# - name: Dashboard - build index.html
#   shell: > 
#     sed 
#     -e "s|DOMAIN_PLACEHOLDER|{{ ingress_domain }}|g" 
#     -e "s|GITEA_USER_PLACEHOLDER|{{ git_user }}|g" 
#     -e "s|GITEA_PAT_PLACEHOLDER|{{ gitea_access_token | default('N/A') }}|g" 
#     -e "s|GITLAB_ROOT_PASSWORD_PLACEHOLDER|{{ gitlab_root_password | default('N/A') }}|g" 
#     -e "s|KEPTN_API_TOKEN_PLACEHOLDER|{{ keptn_api_token | default('N/A') }}|g"
#     -e "s|KEPTN_BRIDGE_USER_PLACEHOLDER|{{ keptn_bridge_user | default('N/A') }}|g"
#     -e "s|KEPTN_BRIDGE_PASSWORD_PLACEHOLDER|{{ keptn_bridge_password | default('N/A') }}|g"
#     -e "s|DYNATRACE_TENANT_PLACEHOLDER|{{ dynatrace_tenant_url | default('N/A') }}|g"
#     /vagrant/docker/dashboard/index.html > /vagrant/docker/dashboard/index-gen.html

- name: Dashboard - build environment
  shell: > 
    sed 
    -e "s|DOMAIN_PLACEHOLDER|{{ ingress_domain }}|g" 
    -e "s|JENKINS_USER_PLACEHOLDER|{{ jenkins_user | default('N/A') }}|g" 
    -e "s|JENKINS_PASSWORD_PLACEHOLDER|{{ jenkins_password | default('N/A') }}|g" 
    -e "s|GITEA_USER_PLACEHOLDER|{{ git_user | default('N/A') }}|g" 
    -e "s|GITEA_PASSWORD_PLACEHOLDER|{{ git_password | default('N/A') }}|g" 
    -e "s|GITEA_PAT_PLACEHOLDER|{{ gitea_access_token | default('N/A') }}|g" 
    -e "s|GITLAB_USER_PLACEHOLDER|{{ gitlab_root_user | default('N/A') }}|g" 
    -e "s|GITLAB_PASSWORD_PLACEHOLDER|{{ gitlab_root_password | default('N/A') }}|g" 
    -e "s|KEPTN_API_TOKEN_PLACEHOLDER|{{ keptn_api_token | default('N/A') }}|g"
    -e "s|KEPTN_BRIDGE_USER_PLACEHOLDER|{{ keptn_bridge_user | default('N/A') }}|g"
    -e "s|KEPTN_BRIDGE_PASSWORD_PLACEHOLDER|{{ keptn_bridge_password | default('N/A') }}|g"
    -e "s|DT_TENANT_URL_PLACEHOLDER|{{ dynatrace_tenant_url | default('N/A') }}|g"
    /vagrant/docker/dashboard/.env-placeholder > /vagrant/docker/dashboard/.env

- name: Encrpyt http basic auth password
  set_fact:
    password_encrypted: "{{ dashboard_password | password_hash('md5') }}"

- name: Encode http basic auth credentials
  set_fact:
    authb64encoded: "{{ [dashboard_user, password_encrypted] | join(':') | b64encode }}"

- name: Dashboard - Build helm chart
  shell: >
    sed
    -e "s|DOMAIN_PLACEHOLDER|{{ ingress_domain }}|g"
    -e "s|AUTH_PLACEHOLDER|{{ authb64encoded }}|g"
    /vagrant/helm-charts/dashboard/values.yaml > /vagrant/helm-charts/dashboard/values-gen.yaml

- name: Build ace dashboard
  become_user: "{{ non_root_user }}"
  shell: docker build -t localhost:32000/dashboard /vagrant/docker/dashboard && docker push localhost:32000/dashboard

- name: Run ace dashboard
  become_user: "{{ non_root_user }}"
  shell: /snap/bin/helm upgrade -i ace-dashboard /vagrant/helm-charts/dashboard -f /vagrant/helm-charts/dashboard/values-gen.yaml --namespace ace
  ignore_errors: yes    