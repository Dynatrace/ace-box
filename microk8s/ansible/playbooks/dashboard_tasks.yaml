- name: Dashboard - Wait for registry to be ready
  shell: /snap/bin/microk8s.kubectl -n container-registry rollout status deployment registry

- name: Dashboard - build index.html
  shell: > 
    sed 
    -e "s|DOMAIN_PLACEHOLDER|{{ ingress_domain }}|g" 
    -e "s|GITEA_USER_PLACEHOLDER|{{ git_user }}|g" 
    -e "s|GITEA_PAT_PLACEHOLDER|{{ gitea_access_token | default('N/A') }}|g" 
    -e "s|KEPTN_API_TOKEN_PLACEHOLDER|{{ keptn_api_token | default('N/A') }}|g"
    -e "s|DYNATRACE_TENANT_PLACEHOLDER|{{ dynatrace_tenant_url | default('N/A') }}|g"
    /vagrant/docker/dashboard/index.html > /vagrant/docker/dashboard/index-gen.html

- name: Dashboard - Set domain for helm chart
  shell: sed -e "s|DOMAIN_PLACEHOLDER|{{ ingress_domain }}|" /vagrant/helm-charts/dashboard/values.yaml > /vagrant/helm-charts/dashboard/values-gen.yaml

- name: Build ace dashboard
  become_user: vagrant
  shell: docker build -t localhost:32000/dashboard /vagrant/docker/dashboard && docker push localhost:32000/dashboard

- name: Run ace dashboard
  become_user: vagrant
  shell: /snap/bin/helm upgrade -i ace-dashboard /vagrant/helm-charts/dashboard -f /vagrant/helm-charts/dashboard/values-gen.yaml --namespace ace
  ignore_errors: yes    