- name: Monaco - Retrieve Gitea access token
  shell: /snap/bin/microk8s.kubectl -n ace get secret gitea-admin -o jsonpath='{.data.access_token}' | base64 -d
  register: gitea_access_token_raw
  ignore_errors: yes

- set_fact:
    gitea_access_token: "{{ gitea_access_token_raw.stdout }}"
  ignore_errors: yes

- name: Monaco - Retrieve Keptn API token
  shell: /snap/bin/microk8s.kubectl get secret keptn-api-token -n keptn -ojsonpath={.data.keptn-api-token} | base64 --decode
  register: keptn_api_token_raw
  ignore_errors: yes

- set_fact:
    keptn_api_token: "{{ keptn_api_token_raw.stdout }}"
  ignore_errors: yes

- name: Monaco - Retrieve Keptn Bridge user
  shell: /snap/bin/microk8s.kubectl get secret bridge-credentials -n keptn -o jsonpath={.data.BASIC_AUTH_USERNAME} | base64 -d
  register: keptn_bridge_user_raw
  ignore_errors: yes

- set_fact:
    keptn_bridge_user: "{{ keptn_bridge_user_raw.stdout }}"
  ignore_errors: yes

- name: Monaco - Retrieve Keptn Bridge password
  shell: /snap/bin/microk8s.kubectl get secret bridge-credentials -n keptn -o jsonpath={.data.BASIC_AUTH_PASSWORD} | base64 -d
  register: keptn_bridge_password_raw
  ignore_errors: yes

- set_fact:
    keptn_bridge_password: "{{ keptn_bridge_password_raw.stdout }}"
  ignore_errors: yes

- name: Monaco - Apply Config
  shell:
    cmd: /usr/local/bin/monaco -e=/vagrant/monaco/environments.yaml -p=acebox /vagrant/monaco/projects
  environment:
    DT_ENV_URL: "{{ dynatrace['tenant'] }}"
    DT_API_TOKEN: "{{ dynatrace['apitoken'] }}"
    INGRESS_DOMAIN: "{{ ingress_domain }}"
    JENKINS_USER: "{{ jenkins_user }}"
    JENKINS_PASSWORD: "{{ jenkins_password }}"
    GITEA_USER: "{{ git_user }}"
    GITEA_PASSWORD: "{{ git_password }}"
    GITEA_PAT: "{{ gitea_access_token | default('n/a') }}"
    KEPTN_API_TOKEN: "{{ keptn_api_token | default('n/a') }}"
    KEPTN_BRIDGE_USER: "{{ keptn_bridge_user | default('n/a') }}"
    KEPTN_BRIDGE_PASSWORD: "{{ keptn_bridge_password | default('n/a') }}"
    GITLAB_USER: "{{ gitlab_user | default('n/a') }}"
    GITLAB_PASSWORD: "{{ gitlab_root_password | default('n/a') }}"
    