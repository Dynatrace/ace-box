#- name: "Dynatrace OneAgent 1 - Enable Dynatrace OneAgent helm repo"
#  become_user: vagrant
#  shell: /snap/bin/helm repo add dynatrace https://raw.githubusercontent.com/Dynatrace/helm-charts/master/repos/stable

#- name: "Dynatrace OneAgent 2 - Create Dynatrace namespace"
#  shell: /snap/bin/microk8s.kubectl create ns dynatrace
#  ignore_errors: yes

#- name: "Dynatrace OneAgent 3 - Install Dynatrace One-Agent Operator"
#  become_user: vagrant
#  shell: /snap/bin/helm install dynatrace-oneagent-operator dynatrace/dynatrace-oneagent-operator -n dynatrace --set platform="kubernetes",oneagent.apiUrl="{{ dynatrace_tenant_url }}/api",secret.apiToken="{{ dynatrace_api_token }}",secret.paasToken="{{ dynatrace_paas_token }}"

- name: "Dynatrace Operator 1 - Download"
  get_url:
    url: "https://github.com/dynatrace/dynatrace-operator/releases/latest/download/install.sh"
    dest: "/home/vagrant/install.sh"
    mode: +x
    timeout: 300

- name: "Dynatrace Operator 2 - Install"
  shell:
    cmd: sh /home/vagrant/install.sh --api-url "{{ dynatrace['tenant'] }}/api" --api-token "{{ dynatrace['apitoken'] }}" --paas-token "{{ dynatrace['paastoken'] }}" --enable-app-log-access --skip-ssl-verification --enable-k8s-monitoring 
