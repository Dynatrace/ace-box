
- name: Gitea - Add helm repo
  become_user: vagrant
  shell: /snap/bin/helm repo add k8s-land https://charts.k8s.land

- set_fact:
    gitea_domain: "gitea.{{ ingress_domain }}"

- name: Gitea - Set placeholders
  shell: >
    sed 
    -e "s|GITEA_INGRESS_PLACEHOLDER|{{ gitea_domain }}|"  
    -e "s|GITEA_VERSION_PLACEHOLDER|{{ gitea_version }}|"  
    /vagrant/k8s/gitea-values.yml > /vagrant/k8s/gitea-values-gen.yml

- name: Gitea - Install gitea using helm
  become_user: vagrant
  shell: /snap/bin/helm install gitea k8s-land/gitea -f /vagrant/k8s/gitea-values-gen.yml --namespace ace
  ignore_errors: yes

- name: Gitea - Wait for gitea to be ready
  shell: /snap/bin/microk8s.kubectl -n ace rollout status deployment gitea-gitea

- name: "Gitea - Create default user {{ git_user }}"
  shell: /snap/bin/microk8s.kubectl exec -t $(kubectl -n ace get po -l app=gitea-gitea -o jsonpath='{.items[0].metadata.name}') -n ace -- bash -c 'su - git -c "/usr/local/bin/gitea --custom-path /data/gitea --config /data/gitea/conf/app.ini  admin create-user --username {{ git_user }} --password {{ git_password }} --email {{ git_email }} --admin --access-token"'
  register: token_raw

- set_fact:
    gitea_access_token: "{{  token_raw.stdout | regex_search('Access token was successfully created... (.*)') | regex_replace ('Access token was successfully created... ', '') }}"

- debug: var=gitea_access_token

# The wait is needed as sometimes the API is not up even though Gitea deployment is ready
- name: Gitea - Wait for API to be up
  uri:
    url: "http://{{ gitea_domain }}/api/v1/admin/orgs?access_token={{ gitea_access_token }}"
    status_code: 200
    validate_certs: no
  register: result
  until: result.status == 200
  retries: 60
  delay: 1

- name: "Gitea - Create org {{ git_org }}"
  shell: "curl -k -d '{\"full_name\":\"{{ git_org }}\", \"visibility\":\"public\", \"username\":\"{{ git_org }}\"}' -H \"Content-Type: application/json\" -X POST \"http://{{ gitea_domain }}/api/v1/orgs?access_token={{ gitea_access_token }}\""

- name: "Gitea - Create repo {{ git_repo }}"
  shell: "curl -k -d '{\"name\":\"{{ git_repo }}\", \"private\":false, \"auto-init\":true}' -H \"Content-Type: application/json\" -X POST \"http://{{ gitea_domain }}/api/v1/org/{{ git_org }}/repos?access_token={{ gitea_access_token }}\""

- name: "Gitea - Git config"
  shell: "git config --global user.email \"{{ git_email }}\" && git config --global user.name \"{{ git_user }}\" && git config --global http.sslverify false"

- name: "Gitea - clone repo http://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ git_org }}/{{ git_repo }}"
  shell: "cd /home/vagrant && git clone http://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ git_org }}/{{ git_repo }}" 

- name: "Gitea - Add files to {{ git_repo }}"
  shell: "cp -r /vagrant/repos/hot-repo/. /home/vagrant/{{ git_repo }}"

- name: "Gitea - Git add/commit for {{ git_repo }}"
  shell: "cd /home/vagrant/{{ git_repo }} && git add . && git commit -m \"Initial commit, enjoy\""

- name: "Gitea - Git push for {{ git_repo }}"
  shell: "cd /home/vagrant/{{ git_repo }} && git push http://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ git_org }}/{{ git_repo }}" 

- name: "Gitea - Create repo docs"
  shell: "curl -k -d '{\"name\":\"docs\", \"private\":false, \"auto-init\":true}' -H \"Content-Type: application/json\" -X POST \"http://{{ gitea_domain }}/api/v1/org/{{ git_org }}/repos?access_token={{ gitea_access_token }}\""

- name: "Gitea - clone repo http://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ git_org }}/docs"
  shell: "cd /home/vagrant && git clone http://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ git_org }}/docs" 

- name: "Gitea - Add files to docs"
  shell: "cp -R /vagrant/repos/docs/* /home/vagrant/docs"

- name: "Gitea - Git add/commit for docs"
  shell: "cd /home/vagrant/docs && git add . && git commit -m \"Initial commit, enjoy\""

- name: "Gitea - Git push for docs"
  shell: "cd /home/vagrant/docs && git push http://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ git_org }}/docs" 

- name: "Gitea - Create repo monaco"
  shell: "curl -k -d '{\"name\":\"monaco\", \"private\":false, \"auto-init\":true}' -H \"Content-Type: application/json\" -X POST \"http://{{ gitea_domain }}/api/v1/org/{{ git_org }}/repos?access_token={{ gitea_access_token }}\""

- name: "Gitea - clone repo http://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ git_org }}/monaco"
  shell: "cd /home/vagrant && git clone http://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ git_org }}/monaco" 

- name: "Gitea - Add files to monaco"
  shell: "cp -R /vagrant/repos/monaco/* /home/vagrant/monaco"

- name: "Gitea - Git add/commit for monaco"
  shell: "cd /home/vagrant/monaco && git add . && git commit -m \"Initial commit, enjoy\""

- name: "Gitea - Git push for monaco"
  shell: "cd /home/vagrant/monaco && git push http://{{ git_user}}:{{ gitea_access_token }}@{{ gitea_domain }}/{{ git_org }}/monaco" 