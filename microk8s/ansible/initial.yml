---
- hosts: all
  become: true
  vars_files:
  - ../config.yml
  vars:
    acebox_mode:                      "{{ acebox['features']['mode'] | default('training') }}"
    feature_activegate:               "{{ acebox['features']['activegate'] | default(false) }}"
    feature_oneagent:                 "{{ acebox['features']['oneagent'] | default(true) }}"
    feature_gitea:                    "{{ acebox['features']['gitea'] | default(false) }}"
    feature_jenkins:                  "{{ acebox['features']['jenkins'] | default(true) }}"
    feature_dashboard:                "{{ acebox['features']['dashboard'] | default(false) }}"
    feature_keptn:                    "{{ acebox['features']['keptn'] | default(false) }}"
    feature_cert_manager:             "{{ acebox['features']['cert_manager'] | default(false) }}"
    dynatrace_tenant_url:             "{{ dynatrace['tenant'] }}" 
    dynatrace_paas_token:             "{{ dynatrace['paastoken'] }}"
    dynatrace_api_token:              "{{ dynatrace['apitoken'] }}"
    jenkins_setcreds:                 "{{ acebox['config']['jenkins']['setcreds'] | default(true) }}"
    jenkins_helm_chart_version:       "{{ acebox['config']['jenkins']['helm_chart_version'] | default('1.27.0') }}"
    jenkins_version:                  "{{ acebox['config']['jenkins']['version'] | default('lts') }}"
    jenkins_ace_lib_url:              "{{ acebox['config']['jenkins']['ace_lib_url'] | default('https://github.com/dynatrace-ace/ace-jenkins-extensions.git') }}"
    jenkins_keptn_lib_url:            "{{ acebox['config']['jenkins']['ace_lib_url'] | default('https://github.com/keptn-sandbox/keptn-jenkins-library.git') }}"
    keptn_version:                        "{{ acebox['config']['keptn']['version'] | default('0.6.2')}}"
    keptn_dynatrace_service_version:      "{{ acebox['config']['keptn']['dynatrace_service_version'] | default('0.8.0')}}"
    keptn_dynatrace_sli_service_version: "{{ acebox['config']['keptn']['dynatrace_sli_service_version'] | default('0.5.0')}}"
    microk8s_addons:            "{{ acebox['config']['microk8s']['addons'] | default('dns storage registry ingress ') }}"
    microk8s_domain_ext:        "{{ acebox['config']['microk8s']['domain_ext'] | default('nip.io') }}"
    ingress_domain:             "{{ acebox['specs']['priv_ip'] | default('192.168.50.10')}}.{{ microk8s_domain_ext }}"
    git_user:                   "{{ acebox['config']['git']['user'] | default('dynatrace') }}"
    git_password:               "{{ acebox['config']['git']['password'] | default('dynatrace') }}"
    git_email:                  "{{ acebox['config']['git']['email'] | default('ace@ace.ace') }}"
    git_org:                    "{{ acebox['config']['git']['org'] | default('ace') }}"
    git_repo:                   "{{ acebox['config']['git']['repo'] | default('ace') }}"
    gitea_version:               "{{ acebox['config']['git']['version'] | default('1.11.6') }}"
    activegate_download_location: "{{ acebox['config']['activegate']['download_location'] | default('/tmp/Dynatrace-ActiveGate-Linux-x86-latest.sh') }}"
  tasks:
  - name: Init install tasks
    import_tasks: playbooks/init_tasks.yaml

  - name: Install and configure microk8s
    import_tasks: playbooks/microk8s_tasks.yaml
  
  - name: Install and configure Dynatrace ActiveGate
    import_tasks: playbooks/dtactivegate_tasks.yaml
    when: feature_activegate == true or acebox_mode == "demo"
  
  - name: Configure Dynatrace tenant
    import_tasks: playbooks/dynatrace_config_tasks.yaml
    when: acebox_mode == "demo"

  - name: Install and configure helm
    import_tasks: playbooks/helm.yaml
  
  - name: Install and configure Dynatrace OneAgent
    import_tasks: playbooks/dtoneagent_tasks.yaml
    when: feature_oneagent == true or acebox_mode == "demo"
  
  - name: Install and configure cert-manager
    import_tasks: playbooks/cert_manager_tasks.yaml
    when: feature_cert_manager == true

  - name: Install and configure Gitea
    import_tasks: playbooks/gitea_tasks.yaml
    when: feature_gitea == true or acebox_mode == "demo"

  - name: Install and configure Keptn
    import_tasks: playbooks/keptn_tasks.yaml
    when: feature_keptn == true or acebox_mode == "demo"

  - name: Install and configure jenkins
    import_tasks: playbooks/jenkins_tasks.yaml
    when: feature_jenkins == true or acebox_mode == "demo"

  - name: Create ACE Dashboard
    import_tasks: playbooks/dashboard_tasks.yaml
    when: feature_dashboard == true or acebox_mode == "demo"

  - name: Post install tasks
    import_tasks: playbooks/postinstall_tasks.yaml