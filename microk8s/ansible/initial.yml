---
- hosts: all
  become: true
  vars_files:
  - ../config.yml
  #roles:
  #- role: Dynatrace.OneAgent
  vars:
    dynatrace_environment_url:  "{{ dynatrace['tenant'] }}"
    dynatrace_paas_token:       "{{ dynatrace['paastoken'] }}"
  tasks:
  - name: Install snapd and disk utils
    apt:
      name: "{{ packages }}"
      state: present
      update_cache: yes
    vars:
      packages:
      - snapd
      - cloud-utils
      - parted
      - docker.io

  - name: Disable swap and resize disk
    become: true
    shell: "swapoff -a && sed -i '/swap/d' /etc/fstab && parted /dev/sda rm 2 && growpart /dev/sda 1 && resize2fs /dev/sda1"
    args:
      removes: /dev/sda2

  - name: Install snap core
    become: true
    command: snap install core

  - name: Install and configure microk8s
    import_tasks: playbooks/microk8s_tasks.yaml

  - name: Add vagrant to docker group
    become: true
    command: usermod -a -G docker vagrant

  - name: Add namespaces
    shell: /snap/bin/microk8s.kubectl create -f /vagrant/k8s/namespaces.yml
    ignore_errors: yes

  - name: Install and configure helm
    import_tasks: playbooks/helm.yaml

  - name: Chmod 777 to docker socker
    become: true
    file:
      path: /var/run/docker.sock
      mode: '0777'
  
  - name: Install and configure jenkins
    import_tasks: playbooks/jenkins_tasks.yaml

  # need to update helm charts for proper Deployment definition
  # - name: Install Gogs local Git Server
  #   become_user: vagrant
  #   shell: /snap/bin/helm upgrade -i -f /vagrant/k8s/gogs-values.yml --namespace services gogs incubator/gogs
  #   ignore_errors: yes

  - name: Build ace dashboard
    become_user: vagrant
    shell: docker build -t localhost:32000/dashboard /vagrant/docker/dashboard && docker push localhost:32000/dashboard

  - name: Run ace dashboard
    become_user: vagrant
    shell: /snap/bin/helm upgrade -i ace-dashboard /vagrant/helm-charts/dashboard --namespace ace
    ignore_errors: yes    

  - name: iptables - Allow forwarding
    become: true
    shell: iptables -P FORWARD ACCEPT

  # INSTALL PRIVATE SYNTHETIC NODE
  #- name: Install and configure Dynatrace ActiveGate
  #  import_tasks: playbooks/dynatrace_tasks.yaml
