---
- hosts: localhost,ace-box
  become: true
  vars_files:
    - ../config.yml
  vars:     
    non_root_user:                    "{{ non_root_user | default('vagrant')}}"
    public_ip:                        "{{ public_ip }}"
    acebox_provisioner:               "{{ acebox_provisioner | default('vagrant')}}"
    acebox_mode:                      "{{ acebox['features']['mode'] | default('training') }}"
    feature_activegate:               "{{ acebox['features']['activegate'] | default(false) }}"
    feature_oneagent:                 "{{ acebox['features']['oneagent'] | default(true) }}"
    feature_gitea:                    "{{ acebox['features']['gitea'] | default(false) }}"
    feature_jenkins:                  "{{ acebox['features']['jenkins'] | default(true) }}"
    feature_dashboard:                "{{ acebox['features']['dashboard'] | default(false) }}"
    feature_keptn:                    "{{ acebox['features']['keptn'] | default(false) }}"
    feature_cert_manager:             "{{ acebox['features']['cert_manager'] | default(false) }}"
    feature_gitlab:                   "{{ acebox['features']['gitlab'] | default(false) }}"
    feature_activegatekube:           "{{ acebox['features']['activegatekube'] | default(false) }}"
    dynatrace_tenant_url:             "{{ dynatrace['tenant'] }}" 
    dynatrace_paas_token:             "{{ dynatrace['paastoken'] }}"
    dynatrace_api_token:              "{{ dynatrace['apitoken'] }}"
    jenkins_setcreds:                 "{{ acebox['config']['jenkins']['setcreds'] | default(true) }}"
    jenkins_helm_chart_version:       "{{ acebox['config']['jenkins']['helm_chart_version'] | default('3.3.18') }}"
    jenkins_version:                  "{{ acebox['config']['jenkins']['version'] | default('2.277.4') }}"
    jenkins_ace_lib_url:              "{{ acebox['config']['jenkins']['ace_lib_url'] | default('https://github.com/dynatrace-ace/dynatrace-jenkins-library.git') }}"
    jenkins_keptn_lib_url:            "{{ acebox['config']['jenkins']['ace_lib_url'] | default('https://github.com/keptn-sandbox/keptn-jenkins-library.git') }}"
    jenkins_user:                     "admin" #not used for configuring jenkins
    jenkins_password:                 "dynatrace" #not used for configuring jenkins
    keptn_version:                        "{{ acebox['config']['keptn']['version'] | default('0.8.4')}}"
    keptn_dynatrace_service_version:      "{{ acebox['config']['keptn']['dynatrace_service_version'] | default('0.14.0')}}"
    keptn_dynatrace_sli_service_version:  "{{ acebox['config']['keptn']['dynatrace_sli_service_version'] | default('0.11.0')}}"
    keptn_jmeter_ext_service_version:     "{{ acebox['config']['keptn']['dynatrace_jmeter_ext_service_version'] | default('0.2.0')}}"
    microk8s_addons:            "{{ acebox['config']['microk8s']['addons'] | default('dns storage registry ingress ') }}"
    microk8s_domain_ext:        "{{ acebox['config']['microk8s']['domain_ext'] | default('nip.io') }}"
    #ingress_domain:             "{{ acebox['specs']['priv_ip'] | default('192.168.50.10')}}.{{ microk8s_domain_ext }}"
    # git_user:                   "{{ acebox['config']['git']['user'] | default('dynatrace') }}"
    # git_password:               "{{ acebox['config']['git']['password'] | default('dynatrace') }}"
    # git_email:                  "{{ acebox['config']['git']['email'] | default('ace@ace.ace') }}"
    # git_org:                    "{{ acebox['config']['git']['org'] | default('ace') }}"
    # git_repo:                   "{{ acebox['config']['git']['repo'] | default('ace') }}"
    git_user:                   "{{ (((acebox | default({})).config | default({}) ).git | default({}) ).user | default('dynatrace') }}"
    git_password:               "{{ (((acebox | default({})).config | default({}) ).git | default({}) ).password | default('dynatrace') }}"
    git_email:                  "{{ (((acebox | default({})).config | default({}) ).git | default({}) ).email | default('ace@ace.ace') }}"
    git_org:                    "{{ (((acebox | default({})).config | default({}) ).git | default({}) ).org | default('ace') }}"
    git_repo:                   "{{ (((acebox | default({})).config | default({}) ).git | default({}) ).repo | default('ace') }}"
    #gitea_version:               "{{ acebox.config.git.version | default('1.11.6') }}"
    gitea_version:               "{{ (((acebox | default({})).config | default({}) ).git | default({}) ).version |default('1.13.2') }}"
    #gitea_version:               "{{ acebox|json_query('config.git.version') | default('1.11.6') }}"
    activegate_download_location: "{{ acebox['config']['activegate']['download_location'] | default('/tmp/Dynatrace-ActiveGate-Linux-x86-latest.sh') }}"
    monaco_download_version: "v1.5.0"
    dashboard_user: "{{ (((acebox | default({})).config | default({}) ).dashboard | default({}) ).user | default('dynatrace') }}"
    dashboard_password: "{{ (((acebox | default({})).config | default({}) ).dashboard | default({}) ).password | default('dynatrace') }}"
  tasks:       
  - name: Set Ingress Domain - Vagrant
    set_fact:
      ingress_domain: "{{ acebox['specs']['priv_ip'] | default('192.168.50.10')}}.{{ microk8s_domain_ext }}"
    when: acebox_provisioner == "vagrant"
    tags:
      - always

  - name: Set Ingress Domain - Terraform
    set_fact:
      ingress_domain: "{{ public_ip }}.{{ microk8s_domain_ext }}"
    when: acebox_provisioner == "terraform"
    tags:
      - always

  - debug: var=ingress_domain
    tags:
      - always

  - name: Init install tasks
    include_tasks: playbooks/init_tasks.yaml
    args:
      apply:
        tags:
          - init
    tags:
      - init

  - name: Install and configure microk8s
    include_tasks: playbooks/microk8s_tasks.yaml
    args:
      apply:
        tags:
          - k8s
    tags:
      - k8s

  - name: Set up Monaco
    include_tasks: playbooks/monaco_tasks.yaml
    when: acebox_mode == "demo"
    args:
      apply:
        tags:
          - monaco
    tags:
      - monaco
  
  - name: Clean Up Dynatrace
    include_tasks: playbooks/monaco_cleanup_tasks.yaml
    when: acebox_mode == "demo"
    args:
      apply:
        tags:
          - monaco
    tags:
      - monaco
  
  - name: Install and configure Dynatrace ActiveGate
    include_tasks: playbooks/dtactivegate_tasks.yaml
    when: feature_activegate or acebox_mode == "demo"
    args:
      apply:
        tags:
          - dt_core
    tags:
      - dt_core
  
  - name: Install and configure helm
    include_tasks: playbooks/helm.yaml
    args:
      apply:
        tags:
          - k8s
    tags:
      - k8s
  
  - name: Install and configure Dynatrace OneAgent
    include_tasks: playbooks/dtoneagent_tasks.yaml
    when: feature_oneagent or acebox_mode == "demo"
    args:
      apply:
        tags:
          - dt_core
    tags:
      - dt_core

  - name: Install and configure cert-manager
    include_tasks: playbooks/cert_manager_tasks.yaml
    when: feature_cert_manager or acebox_provisioner == "terraform"
    args:
      apply:
        tags:
          - k8s
    tags:
      - k8s
  
  - name: Install and configure Gitlab
    include_tasks: playbooks/gitlab_tasks.yaml
    when: feature_gitlab
    args:
      apply:
        tags:
          - git
    tags:
      - git

  - name: Install and configure Gitea
    include_tasks: playbooks/gitea_tasks.yaml
    when: feature_gitea or acebox_mode == "demo"
    tags:
      - git
      - git_uninstall

  - name: Install and configure Keptn
    include_tasks: playbooks/keptn_tasks.yaml
    when: feature_keptn or acebox_mode == "demo"
    args:
      apply:
        tags:
          - keptn
    tags:
      - keptn

  - name: Install and configure jenkins
    include_tasks: playbooks/jenkins_tasks.yaml
    when: feature_jenkins or acebox_mode == "demo"
    tags:
      - jenkins
      - jenkins_uninstall

  - name: Create ACE Dashboard
    include_tasks: playbooks/dashboard_tasks.yaml
    when: feature_dashboard or acebox_mode == "demo"
    args:
      apply:
        tags:
          - dashboard
    tags:
      - dashboard
  
  - name: Configure Dynatrace
    include_tasks: playbooks/monaco_config_tasks.yaml
    when: acebox_mode == "demo"
    args:
      apply:
        tags:
          - monaco
    tags:
      - monaco

  - name: Post install tasks
    include_tasks: playbooks/postinstall_tasks.yaml
    args:
      apply:
        tags:
          - init
          - post_install
    tags:
      - init
      - post_install