---
- hosts: all
  become: true
  vars_files:
  - ../config.yml
  #roles:
  #- role: Dynatrace.OneAgent
  vars:
    feature_activegate:         "{{ acebox['features']['activegate'] | default(false) }}"
    feature_oneagent:           "{{ acebox['features']['oneagent'] | default(true) }}"
    feature_gogs:               "{{ acebox['features']['gogs'] | default(true) }}"
    feature_jenkins:            "{{ acebox['features']['jenkins'] | default(true) }}"
    feature_jenkins_setcreds:   "{{ acebox['features']['jenkins_setcreds'] | default(true) }}"
    feature_dashboard:          "{{ acebox['features']['dashboard'] | default(false) }}"
    feature_demo:               "{{ acebox['features']['demo'] | default(false) }}"
    dynatrace_tenant_url:       "{{ dynatrace['tenant'] }}" #abc1234.live.dynatrace.com
    dynatrace_paas_token:       "{{ dynatrace['paastoken'] }}"
    dynatrace_api_token:        "{{ dynatrace['apitoken'] }}"
    microk8s_addons:            "{{ microk8s['addons'] | default('dns dashboard storage registry') }}"
  tasks:
  - name: Init install tasks
    import_tasks: playbooks/init_tasks.yaml

  - name: Install and configure microk8s
    import_tasks: playbooks/microk8s_tasks.yaml

  - name: Install and configure helm
    import_tasks: playbooks/helm.yaml

  - name: Install and configure Dynatrace OneAgent
    import_tasks: playbooks/dtoneagent_tasks.yaml
    when: feature_oneagent == true

  - name: Add namespaces
    shell: /snap/bin/microk8s.kubectl create -f /vagrant/k8s/namespaces.yml
    ignore_errors: yes

  - name: Install and configure jenkins
    import_tasks: playbooks/jenkins_tasks.yaml
    when: feature_jenkins == true

  - name: Create ACE Dashboard
    import_tasks: playbooks/dashboard_tasks.yaml
    when: feature_dashboard == true

  - name: Install and configure Dynatrace ActiveGate
    import_tasks: playbooks/dtactivegate_tasks.yaml
    when: feature_activegate == true

  - name: Post install tasks
    import_tasks: playbooks/postinstall_tasks.yaml