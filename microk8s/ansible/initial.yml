---
- hosts: all
  become: true
  vars_files:
  - ../config.yml
  #roles:
  #- role: Dynatrace.OneAgent
  vars:
    acebox_mode:                       "{{ acebox['features']['mode'] | default('training') }}"
    feature_activegate:         "{{ acebox['features']['activegate'] | default(false) }}"
    feature_oneagent:           "{{ acebox['features']['oneagent'] | default(true) }}"
    feature_gitea:              "{{ acebox['features']['gitea'] | default(false) }}"
    feature_jenkins:            "{{ acebox['features']['jenkins'] | default(true) }}"
    feature_dashboard:          "{{ acebox['features']['dashboard'] | default(false) }}"
    feature_keptn:              "{{ acebox['features']['keptn'] | default(false) }}"
    dynatrace_tenant_url:       "{{ dynatrace['tenant'] }}" #abc1234.live.dynatrace.com
    dynatrace_paas_token:       "{{ dynatrace['paastoken'] }}"
    dynatrace_api_token:        "{{ dynatrace['apitoken'] }}"
    jenkins_setcreds:           "{{ acebox['config']['jenkins']['setcreds'] | default(true) }}"
    keptn_version:              "{{ acebox['config']['keptn']['version'] | default('0.6.1')}}"
    keptn_bridge_port:          "{{ acebox['config']['keptn']['bridge_port'] | default(31400)}}"
    keptn_api_port:             "{{ acebox['config']['keptn']['api_port'] | default(31401)}}"
    microk8s_addons:            "{{ acebox['config']['microk8s']['addons'] | default('dns dashboard storage registry') }}"
    ingress_domain:             "{{ acebox['specs']['priv_ip'] | default('192.168.50.10')}}.xip.io"
  tasks:
  - name: Init install tasks
    import_tasks: playbooks/init_tasks.yaml

  - name: Install and configure microk8s
    import_tasks: playbooks/microk8s_tasks.yaml

  - name: Install and configure helm
    import_tasks: playbooks/helm.yaml

  - name: Install and configure Dynatrace OneAgent
    import_tasks: playbooks/dtoneagent_tasks.yaml
    when: feature_oneagent == true

  - name: Add namespaces
    shell: /snap/bin/microk8s.kubectl create -f /vagrant/k8s/namespaces.yml
    ignore_errors: yes

  - name: Install and configure jenkins
    import_tasks: playbooks/jenkins_tasks.yaml
    when: feature_jenkins == true

  - name: Install and configure Gitea
    import_tasks: playbooks/gitea_tasks.yaml
    when: feature_gitea == true

  - name: Create ACE Dashboard
    import_tasks: playbooks/dashboard_tasks.yaml
    when: feature_dashboard == true

  - name: Install and configure Dynatrace ActiveGate
    import_tasks: playbooks/dtactivegate_tasks.yaml
    when: feature_activegate == true

  - name: Install and configure Keptn
    import_tasks: playbooks/keptn_tasks.yaml
    when: feature_keptn == true

  - name: Post install tasks
    import_tasks: playbooks/postinstall_tasks.yaml